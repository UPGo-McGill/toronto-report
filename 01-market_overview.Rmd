# Short-term rentals in Toronto: Market overview

<style type="text/css">
  body{
  font-family: Futura, Helvetica, Arial;
}
</style>

<br>

```{r setup, include = FALSE, echo = FALSE}

library(here)
source(here("R", "01_startup.R"))

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

# Function for checking file modifications
mtime <- function(files) lapply(Sys.glob(files), function(x) file.info(x)$mtime)

# Set this to TRUE to output PDF figures
build_figures <- TRUE

```

```{r new_objects, cache=TRUE, cache.lazy=FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())
qload(here("output", "geometry.qsm"), nthreads = availableCores())

# 2019 active
active_2019 <- 
  daily %>%
  filter(housing, status %in% c("R", "A"), date <= end_2019, 
         date >= start_2019) %>%
  pull(property_ID) %>% 
  unique()
  
# 2019 revenue
revenue_2019 <-
  daily %>%
  filter(housing, status == "R", date <= end_2019, 
         date >= start_2019) %>%
  group_by(property_ID) %>%
  summarize(revenue_2019 = sum(price), .groups = "drop") %>% 
  inner_join(property, ., by = "property_ID")

# 2020 active
active_2020 <- 
  daily %>%
  filter(housing, status %in% c("R", "A"), date <= end_2020, 
         date >= start_2020) %>%
  pull(property_ID) %>% 
  unique()

# 2020 revenue
revenue_2020 <-
  daily %>%
  filter(housing, status == "R", date <= end_2020, 
         date >= start_2020) %>%
  group_by(property_ID) %>%
  summarize(revenue_2020 = sum(price), .groups = "drop") %>% 
  inner_join(property, ., by = "property_ID")

# Active listings
active_listings <- 
  daily %>% 
  filter(housing, status != "B") %>% 
  count(date, listing_type) %>% 
  group_by(listing_type) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6, .complete = TRUE)) %>% 
  ungroup()

active_listings <- 
  daily %>% 
  filter(housing, status != "B") %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6, .complete = TRUE),
         listing_type = "All listings") %>% 
  bind_rows(active_listings) %>% 
  arrange(date, listing_type)

# Daily variation
daily_variation <- 
  daily %>% 
  filter(housing, status != "B", date >= "2015-12-16", date != "2020-02-29") %>% 
  group_by(date) %>% 
  summarize("Active listings" = n(), Revenue = sum(price[status == "R"])) %>% 
  mutate(across(where(is.numeric), 
                function(x) slide_dbl(x, ~{(.x[366] - .x[1]) / .x[1]}, 
                                      .before = 365, .complete = FALSE))) %>% 
  pivot_longer(-date, names_to = "var", values_to = "value") %>% 
  group_by(var) %>% 
  mutate(value = slide_dbl(value, mean, .before = 13, .complete = TRUE)) %>% 
  ungroup() %>% 
  filter(date >= "2017-05-01")

# WD breakdown
WD_breakdown <- 
  daily %>% 
  filter(housing, status != "B", date >= start_2020 - years(1), 
         date <= end_2020) %>% 
  group_by(date, ward) %>% 
  summarize(n = n(),
            revenue = sum(price[status == "R"])) %>% 
  left_join(st_drop_geometry(WD)) %>% 
  group_by(ward, dwellings) %>% 
  summarize(active_listings = mean(n[date >= start_2020]),
            active_2019 = mean(n[date < start_2020]),
            active_growth = (active_listings - active_2019) / active_2019,
            annual_rev = sum(revenue[date >= start_2020]),
            rev_2019 = sum(revenue[date < start_2020]),
            rev_growth = (annual_rev - rev_2019) / rev_2019,
            .groups = "drop") %>% 
  mutate(listings_pct = active_listings / sum(active_listings, na.rm = TRUE),
         listings_pct_dwellings = active_listings / dwellings,
         rev_pct = annual_rev / sum(annual_rev)) %>% 
  select(ward, active_listings, active_growth, listings_pct,
         listings_pct_dwellings, annual_rev, rev_pct, rev_growth)

# Active listings by WD
active_WD <-
  daily %>%
  filter(housing, status != "B", date >= start_2020, 
         date <= end_2020) %>%
  count(ward, date) %>% 
  group_by(ward) %>% 
  summarize(n = mean(n, na.rm = TRUE)) %>%
  left_join(WD, .) %>% 
  mutate(percentage = n / dwellings, n = round(n, digit = -1)) %>% 
  select(ward, n, dwellings, percentage)

# Active listings by DA
active_DA <-
  daily %>%
  filter(housing, status != "B", date >= start_2020,
         date <= end_2020) %>%
  left_join(select(st_drop_geometry(property), property_ID, GeoUID)) %>% 
  count(GeoUID, date) %>% 
  group_by(GeoUID) %>% 
  summarize(n = mean(n, na.rm = TRUE)) %>%
  left_join(DA, .) %>% 
  mutate(percentage = n / dwellings, n = round(n, digit = -1),
         percentage = if_else(dwellings <= 4, NA_real_, percentage)) %>% 
  relocate(geometry, .after = last_col())

# Listing type breakdown
listing_type_breakdown <- 
  daily %>% 
  filter(housing, status != "B", date >= start_2020,
         date <= end_2020) %>% 
  group_by(listing_type) %>% 
  summarize(
    active_listings = n() / 365,
    revenue = sum(price[status == "R"]),
    .groups = "drop") %>% 
  mutate(pct_of_listings = active_listings / sum(active_listings),
         pct_of_revenue = revenue / sum(revenue))

listing_type_breakdown <- 
  daily %>% 
  filter(housing, status != "B", date >= start_2020 - years(1), 
         date <= end_2020 - years(1)) %>% 
  group_by(listing_type) %>% 
  summarize(active_2019 = n() / 365) %>% 
  left_join(listing_type_breakdown, .) %>% 
  mutate(pct_listing_growth = (active_listings - active_2019) / active_2019) %>% 
  select(-active_2019)

# Host revenue table for calculations and table
host_rev <-
  daily %>%
  filter(housing, date >= start_2020, date <= end_2020, 
         status == "R", !is.na(host_ID)) %>%
  group_by(host_ID) %>%
  summarize(rev = sum(price))

host_rev19 <-
  daily %>%
  filter(housing, date >= start_2019, date <= end_2019, 
         status == "R", !is.na(host_ID)) %>%
  group_by(host_ID) %>%
  summarize(rev = sum(price))

rm(property, daily, GH, CMA, DA, city)

```

```{r exec_summ, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# Average active and blocked daily listings in 2020
avg_listings <- 
  daily %>% 
  filter(housing, date >= start_2020, date <= end_2020) %>% 
  count(date, B = status == "B") %>% 
  group_by(B) %>% 
  summarize(avg = round(mean(n), digit = -1), .groups = "drop")

avg_listings_active <- 
  avg_listings$avg[1] %>% 
  prettyNum(",")

# Average active and blocked daily listings in 2019
avg_listings19 <- 
  daily %>% 
  filter(housing, date >= start_2019, date <= end_2019) %>% 
  count(date, B = status == "B") %>% 
  group_by(B) %>% 
  summarize(avg = round(mean(n), digit = -1), .groups = "drop")

avg_listings_active19 <- 
  avg_listings19$avg[1] %>% 
  prettyNum(",")

# Total annual revenue in 2020
annual_rev <- 
  revenue_2020$revenue_2020 %>% 
  sum() %>% 
  {. / 1000000} %>% 
  round(digit = 1) %>% 
  prettyNum(",") %>% 
  paste0("$", ., " million")

# Total annual revenue in 2019
annual_rev19 <- 
  revenue_2019$revenue_2019 %>% 
  sum() %>% 
  {. / 1000000} %>% 
  round(digit = 1) %>% 
  prettyNum(",") %>% 
  paste0("$", ., " million")

# EH listings
eh_listings <- 
  listing_type_breakdown %>% 
  filter(listing_type == "Entire home/apt") %>% 
  pull(pct_of_listings) %>% 
  scales::percent(0.1)

# EH revenue
eh_revenue <- 
  listing_type_breakdown %>% 
  filter(listing_type == "Entire home/apt") %>% 
  pull(pct_of_revenue) %>% 
  scales::percent(0.1)

# Host revenue in 2020
host_rev_top_10 <- 
  host_rev %>% 
  summarize(top_10 = sum(rev[rev > quantile(rev, .9)]) / sum(rev)) %>% 
  pull(top_10) %>% 
  scales::percent(0.1)

host_rev_top_1 <- 
  host_rev %>% 
  summarize(top_1 = sum(rev[rev > quantile(rev, .99)]) / sum(rev)) %>% 
  pull(top_1) %>% 
  scales::percent(0.1)

# Host revenue in 2019
host_rev_top_10_2019 <- 
  host_rev19 %>% 
  summarize(top_10 = sum(rev[rev > quantile(rev, .9)]) / sum(rev)) %>% 
  pull(top_10) %>% 
  scales::percent(0.1)

host_rev_top_1_2019 <- 
  host_rev19 %>% 
  summarize(top_1 = sum(rev[rev > quantile(rev, .99)]) / sum(rev)) %>% 
  pull(top_1) %>% 
  scales::percent(0.1)

# 2020 ML listings
ml_listings <- 
  daily %>% 
  filter(housing, status != "B", date >= start_2020, 
         date <= end_2020) %>% 
  count(multi) %>% 
  summarize(ML = n[2] / sum(n)) %>% 
  pull(ML) %>% 
  scales::percent(0.1)

# 2020 ML revenue
ml_revenue <- 
  daily %>% 
  filter(housing, status == "R", date >= start_2020, 
       date <= end_2020) %>% 
  group_by(multi) %>% 
  tally(price) %>% 
  summarize(multi_rev = n[2] / sum(n)) %>% 
  pull(multi_rev) %>% 
  scales::percent(0.1)

# 2019 ML listings
ml_listings19 <- 
  daily %>% 
  filter(housing, status != "B", date >= start_2019, 
         date <= end_2019) %>% 
  count(multi) %>% 
  summarize(ML = n[2] / sum(n)) %>% 
  pull(ML) %>% 
  scales::percent(0.1)

# 2019 ML revenue
ml_revenue19 <- 
  daily %>% 
  filter(housing, status == "R", date >= start_2019, 
       date <= end_2019) %>% 
  group_by(multi) %>% 
  tally(price) %>% 
  summarize(multi_rev = n[2] / sum(n)) %>% 
  pull(multi_rev) %>% 
  scales::percent(0.1)

rm(property, daily, GH)

```

**There were `r avg_listings_active` active STR listings in Toronto housing units in 2020, which collectively earned `r annual_rev`. This is a dramatic decline in comparison with 2019; the COVID-19 pandemic reduced reservations by 68.4%. A quarter of all listings are in the Spadina-Fort York ward. More than three fifths (`r eh_listings`) of Toronto’s STR listings are entire homes, and entire homes are responsible for `r eh_revenue` of all revenue. Revenue is concentrated unevenly among hosts, with the top 10% earning `r host_rev_top_10` of revenue, and the top 1% earning `r host_rev_top_1`. Commercial operators who control multiple STR listings account for `r ml_listings` of listings and `r ml_revenue` of revenue. Toronto has the largest STR market of any Canadian city.**

<br>

## Active daily listings and annual revenue

```{r para_1, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# Average active and blocked daily listings in 2020
avg_listings <- 
  daily %>% 
  filter(housing, date >= start_2020, date <= end_2020) %>% 
  count(date, B = status == "B") %>% 
  group_by(B) %>% 
  summarize(avg = round(mean(n), digit = -1), .groups = "drop")

avg_listings_active <- 
  avg_listings$avg[1] %>% 
  prettyNum(",")

# Average active and blocked daily listings in 2019
avg_listings19 <- 
  daily %>% 
  filter(housing, date >= start_2019, date <= end_2019) %>% 
  count(date, B = status == "B") %>% 
  group_by(B) %>% 
  summarize(avg = round(mean(n), digit = -1), .groups = "drop")

avg_listings_active19 <- 
  avg_listings19$avg[1] %>% 
  prettyNum(",")

# Average number of hosts in 2020 (taking out blocked 365 days)
avg_hosts <- 
  daily %>% 
  filter(housing, status != "B", date >= start_2020, 
         date <= end_2020) %>%
  count(date, host_ID) %>% 
  count(date) %>% 
  summarize(hosts = round(mean(n), digit = -1), .groups = "drop") %>% 
  pull(hosts) %>% 
  prettyNum(",")

# Average number of hosts in 2019 (taking out blocked 365 days)
avg_hosts19 <- 
  daily %>% 
  filter(housing, status != "B", date >= start_2019, 
         date <= end_2019) %>%
  count(date, host_ID) %>% 
  count(date) %>% 
  summarize(hosts = round(mean(n), digit = -1), .groups = "drop") %>% 
  pull(hosts) %>% 
  prettyNum(",")

# Total annual revenue in 2020
annual_rev <- 
  revenue_2020$revenue_2020 %>% 
  sum() %>% 
  {. / 1000000} %>% 
  round(digit = 1) %>% 
  prettyNum(",") %>% 
  paste0("$", ., " million")

# Total annual revenue in 2019
annual_rev19 <- 
  revenue_2019$revenue_2019 %>% 
  sum() %>% 
  {. / 1000000} %>% 
  round(digit = 1) %>% 
  prettyNum(",") %>% 
  paste0("$", ., " million")

# Average revenue per active listing in 2020
avg_rev_per_listing <- 
  (sum(revenue_2020$revenue_2020) /
    daily %>% 
    filter(housing, status != "B", date >= start_2020, 
           date <= end_2020) %>% 
    count(date) %>% 
    summarize(avg_rev_per_active = round(mean(n)), .groups = "drop")) %>% 
  as.vector() %>% 
  round(digit = -2) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

# Average revenue per active listing in 2019
avg_rev_per_listing19 <- 
  (sum(revenue_2019$revenue_2019) /
    daily %>% 
    filter(housing, status != "B", date >= start_2019, 
           date <= end_2019) %>% 
    count(date) %>% 
    summarize(avg_rev_per_active20 = round(mean(n)), .groups = "drop")) %>% 
  as.vector() %>% 
  round(digit = -2) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

#' Average revenue per active host in 2020
avg_rev_per_host <- 
  (sum(revenue_2020$revenue_2020) /
    daily %>% 
    filter(housing, status != "B", date >= start_2020, 
           date <= end_2020) %>%
    group_by(date) %>% 
    summarize(n_hosts = length(unique(host_ID)), .groups = "drop_last") %>% 
    summarize(avg_n_hosts = round(mean(n_hosts)), .groups = "drop")) %>% 
  round(digit = -2) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

#' Average revenue per active host in 2019
avg_rev_per_host19 <- 
  (sum(revenue_2019$revenue_2019) /
    daily %>% 
    filter(housing, status != "B", date >= start_2019, 
           date <= end_2019) %>%
    group_by(date) %>% 
    summarize(n_hosts = length(unique(host_ID)), .groups = "drop_last") %>% 
    summarize(avg_n_hosts20 = round(mean(n_hosts)), .groups = "drop")) %>% 
  round(digit = -2) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

rm(property, daily, GH)

```

``` {r make_fig_1_1}

figure_1_1_fun <- function(regular = "", condensed = "") {
  
  active_listings %>% 
  ggplot(aes(date, n, colour = listing_type, size = listing_type)) +
  geom_line(na.rm = TRUE) +
  scale_y_continuous(name = NULL, label = scales::comma) +
  scale_x_date(name = NULL, limits = c(as.Date("2016-01-01"), NA)) +
  scale_colour_manual(name = NULL, values = col_palette[c(5, 1:3)],
                      guide = guide_legend(
                        override.aes = list(size = c(1.5, 0.75, 0.75, 0.75)))) +
  scale_size_manual(values = c("All listings" = 1.5, "Entire home/apt" = 0.75,
                               "Private room" = 0.75, "Shared room" = 0.75),
                    guide = "none") +
  theme_minimal() +
  theme(legend.position = "bottom", panel.grid.minor.x = element_blank(),
        text = element_text(family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_1.pdf"), 
         plot = figure_1_1_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_1.pdf"))
}

```

Active daily listings are listings which were displayed on Airbnb or Vrbo on a given day, and were either reserved or available for a reservation. It is the most reliable means of determining the overall size of the STR market in a location, particularly with respect to change over time. In 2020 there was an average of `r avg_listings_active` active daily listings (Figure \@ref(fig:fig-1-1)) operated by an average of `r avg_hosts` hosts. These hosts collectively earned `r annual_rev`—an average of `r avg_rev_per_listing` per daily active listing or `r avg_rev_per_host` per active host. Because of the collapse of STR demand during the Covid-19 pandemic, these numbers are substantially lower than 2019, when there was an average of `r avg_listings_active19` active daily listings operated by `r avg_hosts19` hosts, who earned on average `r avg_rev_per_host19`. 

``` {r fig-1-1, include = TRUE, fig.cap = '(ref:fig-1-1)', fig.align = "center"}

figure_1_1_fun()

```

(ref:fig-1-1) _Active daily STRs in the City of Toronto (7-day average)_

``` {r para_2, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# Average blocked daily listings in 2020
avg_listings_blocked <- 
  avg_listings$avg[2] %>% 
  prettyNum(",")

# Average blocked daily listings in 2019
avg_listings_blocked19 <- 
  avg_listings19$avg[2] %>% 
  prettyNum(",")

# Average revenue per all listings in 2020
avg_revenue_all_listings <- 
  revenue_2020$revenue_2020 %>% 
  mean() %>% 
  round(digit = -2) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

# Average revenue per all listings in 2019
avg_revenue_all_listings19 <- 
  revenue_2019$revenue_2019 %>% 
  mean() %>% 
  round(digit = -2) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

# Average revenue per all hosts in 2020
avg_revenue_all_hosts <- 
  revenue_2020 %>% 
  st_drop_geometry() %>%
  filter(!is.na(host_ID)) %>%
  group_by(host_ID) %>% 
  summarize("host_rev" = sum(revenue_2020)) %>% 
  summarize("avg_host_rev" = prettyNum(round(mean(host_rev), digit = -2), ",")) %>% 
  pull(avg_host_rev) %>% 
  paste0("$", .)

# Average revenue per all hosts in 2019
avg_revenue_all_hosts19 <- 
  revenue_2019 %>% 
  st_drop_geometry() %>%
  filter(!is.na(host_ID)) %>%
  group_by(host_ID) %>% 
  summarize("host_rev" = sum(revenue_2019)) %>% 
  summarize("avg_host_rev" = prettyNum(round(mean(host_rev), digit = -2), ",")) %>% 
  pull(avg_host_rev) %>% 
  paste0("$", .)

# Non-housing active listings in 2020
non_housing_listings <- 
  daily %>% 
  filter(!housing, status != "B", date >= start_2020, 
         date <= end_2020) %>%
  count(date) %>% 
  summarize(non_housing = round(mean(n), digit = -1)) %>% 
  pull(non_housing) %>% 
  prettyNum(",")

# Non-housing active listings in 2019
non_housing_listings19 <- 
  daily %>% 
  filter(!housing, status != "B", date >= start_2019, 
         date <= end_2019) %>%
  count(date) %>% 
  summarize(non_housing = round(mean(n), digit = -1)) %>% 
  pull(non_housing) %>% 
  prettyNum(",")

rm(property, daily, GH)

```

There was also a daily average of `r avg_listings_blocked` listings which were visible on the Airbnb and Vrbo websites but were blocked by the host from receiving reservations. The presence of these listings can erroneously suggest that a city’s STR market is larger than it is. When these blocked but inactive listings are included, the average listing earned `r avg_revenue_all_listings` in 2020, and the average host earned `r avg_revenue_all_hosts`. Finally, there was a daily average of `r non_housing_listings` listings that were not located in private housing units (B&Bs, hotels, etc.), which have been excluded from the analysis in this report. All the material which follows pertain to short-term rentals located in Toronto’s residential housing stock.

``` {r para_3, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# Date and amount of highest activity
highest_activity <- 
  daily %>% 
  filter(housing, status != "B") %>% 
  count(date) %>% 
  filter(n == max(n)) %>% 
  group_by(date) %>% 
  summarize(daily_max = round((n), digit = -1))

highest_activity_date <-
  highest_activity$date %>% 
  {paste0(month.name[as.numeric(substr(., 6, 7))], " ", substr(., 1, 4))}

highest_activity_amount <- 
  highest_activity$daily_max %>% 
  prettyNum(",")

# Active listing YOY change in 2019
active_yoy_change19 <- 
  daily %>% 
  filter(housing, status != "B", date >= start_2019 - years(1), 
         date <= end_2019) %>% 
  group_by(year_2019 = date >= start_2019) %>% 
  summarize(active_listings = n() / 365,
            revenue = sum(price[status == "R"]), .groups = "drop") %>% 
  summarize(across(c(active_listings, revenue), ~{(.x[2] - .x[1]) / .x[1]}),
            .groups = "drop")

active_yoy_listings19 <- 
  active_yoy_change19$active_listings %>% 
  {. * 1} %>% 
  scales::percent(accuracy = 0.1)

active_yoy_revenue19 <- 
  active_yoy_change19$revenue %>% 
  scales::percent(accuracy = 0.1)

# Active listing YOY change in 2020
active_yoy_change <- 
  daily %>% 
  filter(housing, status != "B", date >= start_2020 - years(1), 
         date <= end_2020) %>% 
  group_by(year_2020 = date >= start_2020) %>% 
  summarize(active_listings = n() / 365,
            revenue = sum(price[status == "R"]), .groups = "drop") %>% 
  summarize(across(c(active_listings, revenue), ~{(.x[2] - .x[1]) / .x[1]}),
            .groups = "drop")

active_yoy_listings <- 
  active_yoy_change$active_listings %>% 
  {. * -1} %>% 
  scales::percent(accuracy = 0.1)

active_yoy_revenue <- 
  active_yoy_change$revenue %>% 
  scales::percent(accuracy = 0.1)

rm(property, daily, GH)

```

Active daily listings peaked in `r highest_activity_date` at `r highest_activity_amount`, and have since declined. Due to the Covid-19 pandemic, there were `r active_yoy_listings` fewer active listings on average in 2020 than in 2019, and `r active_yoy_revenue` less revenue. Prior to 2020, Toronto's STR market was growing rapidly—active listings and revenue respectively increased by `r active_yoy_listings19` and `r active_yoy_revenue19` from 2018 to 2019. It is likely that this trend would have continued in 2020 in the absence of the pandemic. In general, the number of STR listings available in the City of Toronto peaks during late summer and winter holidays and falls in between these periods (Figure \@ref(fig:fig-1-1)).
  
<br>

## Location of STR listings and revenue

``` {r para_4}

spadina_listing_pct <- 
  WD_breakdown %>% 
  filter(ward == "Spadina-Fort York") %>% 
  pull(listings_pct) %>% 
  scales::percent(0.1)

spadina_rev_pct <- 
  WD_breakdown %>% 
  filter(ward == "Spadina-Fort York") %>% 
  pull(rev_pct) %>% 
  scales::percent(0.1)

university_listing_pct <- 
  WD_breakdown %>% 
  filter(ward == "University-Rosedale") %>% 
  pull(listings_pct) %>% 
  scales::percent(0.1)

university_rev_pct <- 
  WD_breakdown %>% 
  filter(ward == "University-Rosedale") %>% 
  pull(rev_pct) %>% 
  scales::percent(0.1)

centre_listing_pct <- 
  WD_breakdown %>% 
  filter(ward == "Toronto Centre") %>% 
  pull(listings_pct) %>% 
  scales::percent(0.1)

centre_rev_pct <- 
  WD_breakdown %>% 
  filter(ward == "Toronto Centre") %>% 
  pull(rev_pct) %>% 
  scales::percent(0.1)

spadina_per_cap <- 
  WD_breakdown %>% 
  filter(ward == "Spadina-Fort York") %>% 
  pull(listings_pct_dwellings) %>% 
  scales::percent(0.1)

university_per_cap <- 
  WD_breakdown %>% 
  filter(ward == "University-Rosedale") %>% 
  pull(listings_pct_dwellings) %>% 
  scales::percent(0.1)

min_per_cap <- 
  WD_breakdown %>% 
  filter(active_listings > 100) %>% 
  pull(listings_pct_dwellings) %>% 
  min() %>% 
  scales::percent(0.1)

max_per_cap <- 
  WD_breakdown %>% 
  filter(active_listings > 100, 
         !active_listings %in% c("Spadina-Fort York", "Toronto Centre")) %>% 
  pull(listings_pct_dwellings) %>% 
  max() %>% 
  scales::percent(0.1)

```

```{r on_water, cache = TRUE, cache.lazy = FALSE}

qload(here("output", "geometry.qsm"), nthreads = availableCores())

ocean <- 
  read_sf(here("data", "shapefiles", "lhy_000h16a_e.shp")) %>% 
  st_transform(32617)

ocean <- 
  ocean %>% 
  st_filter(rbind(select(CMA, -everything()), select(city, -everything())))

river <- 
  read_sf(here("data", "shapefiles", "lhy_000c16a_e.shp")) %>% 
  st_transform(32617)

river <- 
  river %>% 
  st_filter(rbind(select(CMA, -everything()), select(city, -everything())))

water <- rbind(select(river, -everything()), select(ocean, -everything()))

rm(ocean, river, city, CMA)
```

``` {r make_fig_1_2}

figure_1_2_fun <- function(regular = "", condensed = "") {
  
  left_map <- 
    active_WD %>% 
    ggplot() +
    geom_sf(data = province, colour = "transparent", fill = "grey93") +
    geom_sf(aes(fill = percentage), colour = "white") +
    geom_sf(data = water, fill = "white", colour = "transparent") +
    scale_fill_gradientn(colors = col_palette[c(3, 4, 5)], 
                         na.value = "grey80",
                         limits = c(0, 0.04), oob = scales::squish, 
                         labels = scales::percent)  +
    guides(fill = guide_colourbar(title = "STRs/\ndwelling",
                                  title.vjust = 1)) + 
    gg_bbox(active_DA) +
    theme_void() +
    theme(text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold",
                                      size = 7),
          legend.title.align = 0.9,
          legend.text = element_text(family = regular, size = 5),
          panel.border = element_rect(colour = "white", size = 2))
  
  right_map <- 
    active_DA %>% 
    ggplot() +
    geom_sf(data = province, colour = "transparent", fill = "grey93") +
    geom_sf(aes(fill = percentage), colour = "transparent") +
    geom_sf(data = water, fill = "white", colour = "transparent") +
    scale_fill_gradientn(colors = col_palette[c(3, 4, 5)], 
                         na.value = "grey80",
                         limits = c(0, 0.1), oob = scales::squish, 
                         labels = scales::percent)  +
    guides(fill = guide_colourbar(title = "STRs/\ndwelling",
                                  title.vjust = 1)) + 
    gg_bbox(active_DA) +
    theme_void() +
    theme(text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold",
                                      size = 7),
          legend.title.align = 0.9,
          legend.text = element_text(family = regular, size = 5),
          panel.border = element_rect(colour = "white", size = 2))
  
  left_map + right_map + plot_layout(guide = "collect") & 
    theme(legend.position = "bottom", legend.key.width = unit(1.8, "lines"))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_2.pdf"), 
         plot = figure_1_2_fun("Futura", "Futura Condensed"), 
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_2.pdf"))
}

```

STR activity in Toronto is highly concentrated downtown (Figure \@ref(fig:fig-1-2)). In particular, the Spadina-Fort York ward (which includes the Waterfront area), accounts for `r spadina_listing_pct` of all listings, and an even higher share of host revenue (`r spadina_rev_pct`). Spadina-Fort York is followed by the University-Rosedale ward (`r university_listing_pct` of active listings and `r university_rev_pct` of revenue) and the Toronto Centre ward (`r centre_listing_pct` of active listings and `r centre_rev_pct` of revenue). When measured in per-capita terms, Spadina-Fort York and University-Rosedale have the highest concentrations of STRs, at `r spadina_per_cap` and `r university_per_cap` respectively. In all other wards STRs account for between `r min_per_cap` and `r max_per_cap` of total dwellings.


``` {r fig-1-2, include = TRUE, fig.cap = '(ref:fig-1-2)', fig.align = "center"}

figure_1_2_fun()

```

(ref:fig-1-2) _Active STRs as a share of all dwelling units in Toronto, by ward (L) and dissemination area (R)_

``` {r tab-1-1, include = TRUE}

library(kableExtra)

WD_breakdown %>% 
  select(ward, active_listings, active_growth, listings_pct_dwellings,
         annual_rev, rev_growth) %>% 
  filter(active_listings > 100) %>% 
  arrange(-active_listings) %>% 
  mutate(active_listings = prettyNum(round(active_listings, -1), ","),
         active_growth = scales::percent(active_growth, 0.1),
         listings_pct_dwellings = scales::percent(listings_pct_dwellings, 0.1),
         annual_rev = scales::dollar(annual_rev, 0.1, scale = 1 / 1000000),
         rev_growth = scales::percent(rev_growth, 0.1)) %>%
  add_row(ward = "City of Toronto",
          active_listings = avg_listings_active,
          active_growth = paste0("-", active_yoy_listings),
          listings_pct_dwellings = {
            avg_listings_active %>% 
              parse_number() %>% 
              {. / sum(WD$dwellings)} %>% 
              scales::percent(0.1)},
          annual_rev = str_remove(annual_rev, " million"),
          rev_growth = active_yoy_revenue,
          .before = 1) %>% 
  set_names(c("Ward", 
              "Active listings",
              "Annual listing growth",
              "Active listings as % of dwellings",
              "Annual revenue (million)",
              "Annual revenue growth")) %>% 
  kbl(caption = "Wards with at least 100 daily active listings in 2020",
               align = "lrrrrr") %>% 
  kable_styling(latex_options="scale_down") %>% 
  row_spec(1, background = paste0(col_palette[2], "50"))

  
```

<br>

## Listing types and sizes

STRs listed on Airbnb can be one of four types: entire homes or apartments, private rooms, shared rooms, and hotel rooms. We have excluded the latter from our analysis, since we focus only on STRs located in housing units. Most policy attention has been focused on entire-home listings, both because these listings are most likely to generate harmful negative externalities, including housing loss and area nuisance, and because entire-home listings tend to be the most common. 

``` {r para_5, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

bedrooms <- 
  property %>% 
  st_drop_geometry() %>% 
  filter(property_ID %in% active_2020, listing_type == "Entire home/apt") %>% 
  mutate(bedrooms = if_else(bedrooms >= 3, "3+", as.character(bedrooms))) %>% 
  count(bedrooms) %>% 
  mutate(percentage = n / sum(n))

one_bedrooms <- 
  bedrooms %>% 
  filter(bedrooms == "1") %>% 
  pull(percentage) %>% 
  scales::percent(0.1)

two_bedrooms <- 
  bedrooms %>% 
  filter(bedrooms == "2") %>% 
  pull(percentage) %>% 
  scales::percent(0.1)

three_bedrooms <- 
  bedrooms %>% 
  filter(bedrooms == "3+") %>% 
  pull(percentage) %>% 
  scales::percent(0.1)

studios <- 
  bedrooms %>% 
  filter(bedrooms == "0") %>% 
  pull(percentage) %>% 
  scales::percent(0.1)

eh_3_bedroom <- 
  property %>% 
  filter(housing, created <= end_2020, scraped >= start_2020, 
         listing_type == "Entire home/apt", !is.na(bedrooms)) %>% 
  st_drop_geometry() %>% 
  summarize(bed_3 = mean(bedrooms <= 3)) %>% 
  pull(bed_3) %>% 
  scales::percent(0.1)

rm(property, daily, GH)

```

Table \@ref(tab:tab-1-2) provides the distribution of the listings by listing type in 2020. The majority of STRs in Toronto are entire homes, a category which includes single-family homes, townhouses, apartments and condominiums. Half (`r one_bedrooms`) of these were one-bedroom housing units, and more than a quarter (`r two_bedrooms`) were two-bedrooms units. `r three_bedrooms` had three or more bedrooms, and `r studios` were studios. In general, studios and one-bedroom units are over-represented on STR platforms in comparison with the City’s overall housing stock.

``` {r tab-1-2, include = TRUE}

library(kableExtra)

listing_type_breakdown %>%
  mutate(active_listings = prettyNum(round(active_listings, digits = -1), ","),
         revenue = scales::dollar(revenue, 0.1, 1 / 1000000),
         pct_of_listings = scales::percent(pct_of_listings, 0.1),
         pct_of_revenue = scales::percent(pct_of_revenue, 0.1),
         pct_listing_growth = scales::percent(pct_listing_growth, 0.1)) %>% 
  rename(`Listing type` = listing_type,
         `Active listings` = active_listings,
         `Annual revenue (million)` = revenue,
         `Share of all listings` = pct_of_listings,
         `Share of all revenue` = pct_of_revenue,
         `Annual listing growth` = pct_listing_growth
         ) %>% 
  kbl(caption = "Listing type prevalence in the City of Toronto",
               align = "lrrrrr") %>% 
  kable_styling(latex_options="scale_down")

```

In 2020 entire-home listings accounted for `r eh_listings` of all daily active listings, and `r eh_revenue` of total host revenue. (Private rooms accounted for nearly all of the remainder.) Moreover, the dominance of entire-home listings in Toronto’s STR market is increasing over time.

<br>

## STR growth rates

``` {r make_fig_1_3}

figure_1_3_fun <- function(regular = "", condensed = "") {
  
  daily_variation %>% 
  ggplot(aes(date, value, colour = var)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  geom_line(lwd = 1, na.rm = TRUE) +
  scale_x_date(name = NULL) +
  scale_y_continuous(name = NULL, limits = c(-1, NA), 
                     labels = scales::percent) +
  scale_color_manual(name = NULL, values = col_palette[c(5, 1)]) +
  theme_minimal() +
  theme(legend.position = "bottom", panel.grid.minor.x = element_blank(),
        text = element_text(family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_3.pdf"), 
         plot = figure_1_3_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_3.pdf"))
}

```

Until the end of 2019, the number of active STRs listings was steadily increasing in the City of Toronto. Figure \@ref(fig:fig-1-3) shows the change in active listings and revenue relative to one year earlier, which is a convenient way to remove seasonal variation to identify underlying growth trends. The figure indicates that, throughout 2017 and the first half of 2018, there was great growth in the revenue earned by hosts. From mid-2018 to late 2019, both active listings and revenue were greater than the year before, albeit with less growth. Both active listings and revenue grew sharply during the 2019 winter season. The pandemic halted Toronto's STR market growth, with active listings and revenue declining since March.

``` {r fig-1-3, include = TRUE, fig.cap = '(ref:fig-1-3)', fig.align = "center"}

figure_1_3_fun()

```

(ref:fig-1-3) _Change in daily active listings and host revenue compared to one year earlier (14-day average)_

``` {r para_6, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# YOY listing growth, 2016-2017
listing_growth_2017 <- 
  daily %>% 
  filter(housing, status != "B", date >= start_2019 - years(3),
         date <= end_2019 - years(2)) %>% 
  group_by(year_2017 = date >= start_2019 - years(2)) %>% 
  summarize(n = n() / 365) %>% 
  summarize(change = (n[2] - n[1]) / n[1]) %>% 
  pull(change) %>% 
  scales::percent(0.1)

# YOY listing growth, 2017-2018
listing_growth_2018 <- 
  daily %>% 
  filter(housing, status != "B", date >= start_2019 - years(2),
         date <= end_2019 - years(1)) %>% 
  group_by(year_2018 = date >= start_2019 - years(1)) %>% 
  summarize(n = n() / 365) %>% 
  summarize(change = (n[2] - n[1]) / n[1]) %>% 
  pull(change) %>% 
  scales::percent(0.1)

#' YOY listing growth, 2018-2019
listing_growth_2019 <- 
  daily %>% 
  filter(housing, status != "B", date >= start_2019 - years(1),
         date <= end_2019) %>% 
  group_by(year_2019 = date >= start_2019) %>% 
  summarize(n = n() / 365) %>% 
  summarize(change = (n[2] - n[1]) / n[1])  %>% 
  pull(change) %>% 
  scales::percent(0.1)

# End month
end_month <- 
  max(daily$date) %>% 
  substr(6, 7) %>% 
  as.numeric() %>% 
  {month.name[.]}

# YOY listing growth, 2019-2020
listing_growth_2020 <- 
  daily %>% 
  filter(housing, status != "B", date >= start_2019,
         date <= end_2020,
         (date <= max(daily$date) - years(1) | date >= start_2020),
         date != "2020-02-29") %>%
  group_by(year_2020 = date >= start_2020) %>% 
  summarize(n = n() / as.numeric((max(daily$date) - as.Date("2020-01-01")))) %>% 
  summarize(change = (n[2] - n[1]) / n[1])  %>% 
  pull(change) %>% 
  scales::percent(0.1)

rm(property, daily, GH)

```

Overall, the year-over-year change in average active listings from 2016 to 2017  was `r listing_growth_2017`, the year-over-year change from 2017 to 2018 was `r listing_growth_2018`, and the year-over-year change from 2018 to 2019 was `r listing_growth_2019`. In 2020, because of the Covid-19 pandemic, the year-over-year change in active daily listings is `r listing_growth_2020`.

``` {r para_7, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# YOY reservation change, 2019-2020
reservation_change_2020 <- 
  daily %>%
  filter(housing, status == "R", date >= start_2020 - years(1),
         date <= end_2020) %>%
  group_by(year_2020 = date >= start_2020) %>%
  summarize(n = n()) %>%
  summarize(change = (n[2] - n[1]) / n[1]) %>% 
  pull(change) %>% 
  scales::percent(0.1)

# YOY reservation change, 2018-2019
reservation_change_2019 <- 
  daily %>%
  filter(housing, status == "R", date >= start_2019 - years(1),
         date <= end_2019) %>%
  group_by(year_2019 = date >= start_2019) %>%
  summarize(n = n()) %>%
  summarize(change = (n[2] - n[1]) / n[1]) %>% 
  pull(change) %>% 
  scales::percent(0.1)

# Reservation counts, 2019-2020
reservation_count_2020 <- 
  daily %>%
  filter(housing, status == "R", date >= start_2020 - years(1),
         date <= end_2020) %>%
  group_by(year_2020 = date >= start_2020) %>%
  summarize(n = n()) %>% 
  mutate(n = n / 1000000,
         n = round(n, 2),
         n = paste0(n, " million")) %>% 
  pull(n)

# Reservation counts, 2018-2019
reservation_count_2019 <- 
  daily %>%
  filter(housing, status == "R", date >= start_2019 - years(1),
         date <= end_2019) %>%
  group_by(year_2019 = date >= start_2019) %>%
  summarize(n = n()) %>% 
  mutate(n = n / 1000000,
         n = round(n, 2),
         n = paste0(n, " million")) %>% 
  pull(n)

# YOY revenue change, 2019-2020
active_yoy_revenue_2020 <- 
  daily %>%
  filter(housing, status == "R", date >= start_2019,
         date <= end_2019 + years(1),
         (date <= "2019-07-31" | date >= start_2019 + years(1)),
         date != "2020-02-29") %>%
  group_by(year_2020 = date >= start_2019 + years(1)) %>%
  summarize(revenue = sum(price)) %>%
  summarize(change = (revenue[2] - revenue[1]) / revenue[1]) %>% 
  pull(change) %>% 
  {. * -1} %>% 
  scales::percent(0.1)


rm(property, daily, GH)

```

```{r active_listings, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

active_by_status <- 
  daily %>% 
  filter(housing, date >= "2016-01-01", status %in% c("R", "A")) %>% 
  count(date, status)

reserved_nights_increase_2019 <- 
  daily %>% 
  filter(housing, status == "R", date >= start_2019 - years(1), 
         date <= end_2019) %>% 
  count(date_2019 = date >= start_2019) %>% 
  summarize(growth = (n[2] - n[1]) / n[1]) %>% 
  pull(growth) %>% 
  scales::percent(0.1)

reserved_nights_decrease_2020 <- 
  daily %>% 
  filter(housing, status == "R", date >= start_2020 - years(1), 
         date <= end_2020) %>% 
  count(date_2019 = date >= start_2020) %>% 
  summarize(growth = (n[2] - n[1]) / n[1]) %>% 
  pull(growth) %>% 
  scales::percent(0.1)

reserved_nights_increase_jan_feb <- 
  daily %>% 
  filter(housing, status == "R", date >= start_2019, 
         month(date) %in% c(1, 2)) %>% 
  count(date_2020 = date >= start_2020) %>% 
  summarize(growth = (n[2] - n[1]) / n[1]) %>% 
  pull(growth) %>% 
  scales::percent(0.1)


rm(property, daily, GH)

```

```{r reservation_trend, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

library(feasts)
library(fabletools)

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# Create and decompose reservations time series
reservations <- 
  active_by_status %>% 
  filter(status == "R") %>% 
  tsibble::as_tsibble() %>% 
  tsibble::index_by(yearmon = tsibble::yearmonth(date)) %>% 
  summarize(n = sum(n)) %>% 
  filter(yearmon <= tsibble::yearmonth("2020-02")) %>% 
  model(x11 = feasts:::X11(n, type = "additive")) %>% 
  components()

# Get March-Dec seasonal
mar_dec_seasonal <- 
  reservations %>% 
  slice(39:49) %>% 
  pull(seasonal)

# Get Feb trend
feb_trend <- 
  reservations %>% 
  slice(50) %>% 
  pull(trend)

# Apply March-Dec seasonal component to Feb trend
trends <-
  tibble(
    date = as.Date(c("2020-03-16", "2020-04-16", "2020-05-16", "2020-06-16",
                     "2020-07-16", "2020-08-16", "2020-09-16", "2020-10-16",
                     "2020-11-16", "2020-12-16", "2020-12-31")),
    trend = (feb_trend + mar_dec_seasonal) / 
      c(31, 30, 31, 30, 31, 31, 30, 31, 30, 31, 31))

# Set Dec 31 value to average of November and December
trends[11,]$trend <- mean(trends[10:11,]$trend)

reservations <- 
  active_by_status %>% 
  filter(status == "R") %>% 
  mutate(n = slide_dbl(n, mean, .before = 6)) %>% 
  filter(date >= "2019-01-01") %>% 
  left_join(trends) %>% 
  select(-status) %>% 
  mutate(trend = if_else(date == "2020-03-01", n, trend)) %>% 
  filter(date >= "2020-03-01") %>% 
  mutate(trend = zoo::na.approx(trend))

reservations <- 
  active_by_status %>% 
  filter(status == "R") %>% 
  mutate(n = slide_dbl(n, mean, .before = 6)) %>% 
  filter(date >= "2019-01-01", date <= "2020-02-29") %>% 
  select(-status) %>% 
  bind_rows(reservations) 

# Reservation comparisons
res_table <- 
  reservations %>% 
  filter(date == "2020-12-31") %>% 
  mutate(dif = trend - n, pct_change = 1 - n / trend)

res_2020 <- 
  prettyNum(round(res_table$n, -1), ",")

res_2020_trend <- 
  prettyNum(round(res_table$trend, -1), ",")

res_2020_pct <- 
  scales::percent(1 - res_table$n / res_table$trend, 0.1)

res_2020_dif <- 
  prettyNum(round(res_table$trend - res_table$n, -1), ",")

pandemic_reservations <- 
  reservations %>% 
  filter(date >= "2020-03-01") %>% 
  summarize(across(c(n, trend), sum)) %>% 
  mutate(dif = trend - n, pct = n / trend)

res_total_pandemic_dif <- 
  prettyNum(round(pandemic_reservations$trend - pandemic_reservations$n, -2), 
            ",")

res_total_pandemic <- 
  prettyNum(round(pandemic_reservations$n, -2), ",")

res_total_pandemic_pct <- 
  scales::percent(pandemic_reservations$n / pandemic_reservations$trend, 0.1)

res_total_pandemic_trend <- 
  prettyNum(round(pandemic_reservations$trend, -2), ",")
 
rm(property, daily, GH)

```

``` {r make_fig_1_5}

 figure_1_5_fun <- function(regular = "", condensed = "") {
   
   reservations %>% 
     pivot_longer(-date) %>% 
     filter(!is.na(value)) %>%
     ggplot() +
     geom_ribbon(aes(x = date, ymin = n, ymax = trend, group = 1),
                 data = reservations, fill = col_palette[3], 
                 alpha = 0.3) +
     geom_line(aes(date, value, color = name), lwd = 1) +
     geom_text(aes(x = as.Date("2020-12-31"), 
                   y = mean(value[date == as.Date("2020-12-31")]),
                   label = paste(
                     prettyNum(round(abs(diff(
                       value[date == as.Date("2020-12-31")])), -1), ","),
                     "fewer", "reservations", "than", "expected", sep = "\n")), 
               inherit.aes = FALSE, hjust = 1, family = condensed, 
               nudge_x = -4) +
     geom_segment(aes(x = as.Date("2020-12-31"), xend = as.Date("2020-12-31"),
                      y = min(value[date == as.Date("2020-12-31")]),
                      yend = max(value[date == as.Date("2020-12-31")])),
                  colour = col_palette[1],
                  arrow = arrow(length = unit(0.1, "cm"), ends = "both",
                                type = "open")) +
     scale_x_date(name = NULL) +
     scale_y_continuous(name = NULL, limits = c(0, NA), label = scales::comma) +
     scale_color_manual(name = NULL, labels = c("Actual reservations", 
                                                "Expected reservations"), 
                        values = col_palette[c(5, 1)]) +
     theme_minimal() +
     theme(legend.position = "bottom", 
           panel.grid.minor.x = element_blank(),
           text = element_text(face = "plain", family = regular),
           legend.text = element_text( size = 10, family = regular))
 
 }
 
 if (build_figures) {
   ggsave(here("output", "figures", "figure_1_5.pdf"), 
          plot = figure_1_5_fun("Futura", "Futura Condensed"), 
          width = 8, height = 5, units = "in", useDingbats = FALSE)
   
   extrafont::embed_fonts(here("output", "figures", "figure_1_5.pdf"))
 }

```

Figure \@ref(fig:fig-1-5) provides a closer look at daily reservations since 2019, comparing the actual trajectory of reservations during the pandemic with what the trajectory of reservations would have been expected to be, based on previous growth in Toronto's STR market but in the absence of the pandemic. (To do this, we use seasonal decomposition to identify the regular seasonal fluctuations in STR activity and separate them from the underlying patterns of growth or decline.) In total, from March through December 2020, we estimate that there have been `r res_total_pandemic_dif` fewer STR nights reserved than would normally have been expected to occur. The `r res_total_pandemic` total nights reserved in this time period is only `r res_total_pandemic_pct` of the `r res_total_pandemic_trend` nights total that would represent the previous growth trend.

``` {r fig-1-5, include = TRUE, fig.cap = '(ref:fig-1-5)', fig.align = "center"}

figure_1_5_fun()

```

(ref:fig-1-5) _Actual and expected reservations during the Covid-19 pandemic (7-day average)_

```{r prices, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())
 
# Get average nightly prices
average_prices <- 
  daily %>% 
  filter(housing, status == "R", date >= "2016-01-01",
         listing_type == "Entire home/apt") %>% 
  group_by(date) %>% 
  summarize(price = mean(price))

# Create monthly price time series
monthly_prices <- 
  average_prices %>% 
  tsibble::as_tsibble() %>% 
  tsibble::index_by(yearmon = tsibble::yearmonth(date)) %>% 
  summarize(price = mean(price))

# Get March-December seasonal
mar_dec_price_seasonal <- 
  monthly_prices %>% 
  filter(yearmon <= tsibble::yearmonth("2020-02")) %>% 
  model(x11 = feasts:::X11(price, type = "additive")) %>% 
  components() %>%
  slice(39:48) %>% 
  pull(seasonal)

# Get Feb trend
feb_price_trend <- 
  monthly_prices %>% 
  filter(yearmon <= tsibble::yearmonth("2020-02")) %>% 
  model(x11 = feasts:::X11(price, type = "additive")) %>% 
  components() %>% 
  slice(50) %>% 
  pull(trend)

# Apply March-Sep seasonal component to Feb trend
mar_dec_price_trend <- 
  tibble(yearmon = tsibble::yearmonth(c(
    "2020-03", "2020-04", "2020-05", "2020-06", "2020-07", "2020-08",
    "2020-09", "2020-10", "2020-11", "2020-12")),
    trend = (feb_price_trend + mar_dec_price_seasonal))

# Apply to daily averages to get trend
average_prices <- 
  average_prices %>% 
  mutate(yearmon = tsibble::yearmonth(date)) %>% 
  inner_join(mar_dec_price_trend) %>% 
  group_by(yearmon) %>% 
  mutate(trend = price * trend / mean(price)) %>% 
  ungroup() %>% 
  select(date, trend) %>% 
  left_join(average_prices, .)

 nightly_price_dif <- 
   average_prices %>% 
   filter(date >= "2020-03-01") %>% 
   summarize(dif = 1 - sum(price) / sum(trend)) %>% 
   pull(dif) %>% 
   scales::percent(0.1)
 
 total_price_dif <- 
   average_prices %>%
   rename(price_trend = trend) %>% 
   filter(date >= "2020-03-01") %>% 
   left_join(reservations) %>% 
   mutate(rev_dif = n * (price_trend - price)) %>% 
   tally(rev_dif) %>% 
   pull(n) %>% 
   scales::dollar(0.1, 1 / 1000000, suffix = " million")
 
 total_revenue_lost <- 
   average_prices %>%
   rename(price_trend = trend) %>% 
   filter(date >= "2020-03-01") %>% 
   left_join(reservations) %>% 
   mutate(total_rev_dif = n * (price_trend - price) + 
            (trend - n) * price_trend) %>% 
   tally(total_rev_dif) %>% 
   pull(n) %>% 
   scales::dollar(0.1, 1 / 1000000, suffix = " million")

rm(property, daily, GH)

```

STR host revenue decreased by a staggering `r active_yoy_revenue` in 2020 compared to 2019. To offer some perspective, from 2018 to 2019, STR revenue increased by `r active_yoy_revenue19`. Throughout the May-December period of 2020, moreover, nightly prices have been an average of `r nightly_price_dif` lower than expected. Spread across the `r res_total_pandemic` nights reserved during this period, this means that STR operators collectively earned `r total_price_dif` less than they would have on their bookings in the absence of the pandemic. When the lower prices on reservations which did occur is combined with the reservations which did not occur, our estimate is that Toronto’s STR hosts lost a total of `r total_revenue_lost` million in revenue between March and December 2020 because of the Covid-19 pandemic.

<br>

## Revenue distribution among STR hosts

A crucial concept for understanding the structure of an STR market is the distinction between casual STRs (“home sharing”) and dedicated STRs (“commercial operations”). One way to capture this distinction is to examine the distribution of revenue among STR hosts. Is revenue widely distributed between many part-time hosts of single listings, or concentrated among a small number of commercial operators who control many full-time listings?
While hosts are identified on Airbnb or Vrbo with unique accounts, these accounts are not necessarily an accurate guide to the individuals or companies which operate STR listings, since a given person or group of people can create as many host accounts as they wish, and split their listings among these accounts. What may appear superficially as a large number of small STR operators could thus be in reality a much smaller number of operators controlling many accounts each. To address this possibility, we use custom image recognition software to identify identical photographs which are used across multiple listings, and thereby construct groups of host accounts which are either a single operator or a network of operators working in collaboration. If multiple, apparently separate host accounts use the identical photo on the webpages of their STR listings, this is very strong evidence that these accounts are related.

``` {r para_9, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# Host deciles table for figure
host_deciles <-
  daily %>%
  filter(housing, date >= start_2020, date <= end_2020, 
         status == "R", !is.na(host_ID)) %>%
  group_by(host_ID) %>%
  summarize(rev = sum(price)) %>% 
  summarize(all = sum(rev),
            top_10 = sum(rev[rev > quantile(rev, c(0.90))] / all),
            top_20 = sum(rev[rev > quantile(rev, c(0.80))] / all) - 
              sum(rev[rev > quantile(rev, c(0.90))] / all),
            top_30 = sum(rev[rev > quantile(rev, c(0.70))] / all) - 
              sum(rev[rev > quantile(rev, c(0.80))] / all),
            top_40 = sum(rev[rev > quantile(rev, c(0.60))] / all) - 
              sum(rev[rev > quantile(rev, c(0.70))] / all),
            top_50 = sum(rev[rev > quantile(rev, c(0.50))] / all) - 
              sum(rev[rev > quantile(rev, c(0.60))] / all),
            top_60 = sum(rev[rev > quantile(rev, c(0.40))] / all) - 
              sum(rev[rev > quantile(rev, c(0.50))] / all),
            top_70 = sum(rev[rev > quantile(rev, c(0.30))] / all) - 
              sum(rev[rev > quantile(rev, c(0.40))] / all),
            top_80 = sum(rev[rev > quantile(rev, c(0.20))] / all) - 
              sum(rev[rev > quantile(rev, c(0.30))] / all),
            top_90 = sum(rev[rev > quantile(rev, c(0.10))] / all) - 
              sum(rev[rev > quantile(rev, c(0.20))] / all),
            top_100 = sum(rev[rev > quantile(rev, c(0.00))] / all) - 
              sum(rev[rev > quantile(rev, c(0.10))] / all)) %>% 
  select(-all) %>% 
  pivot_longer(everything(), names_to = "percentile", values_to = "value") %>% 
  mutate(percentile = factor(percentile, levels = paste0("top_", 1:10 * 10))) %>% 
  mutate(perfect_distribution = 0.1,
         decile = 1:10,
         dummy_1 = perfect_distribution,
         dummy_2 = value) %>%  
  rename("0" = perfect_distribution, "1" = value, "0.25" = dummy_1, 
         "0.75" = dummy_2) %>%
  pivot_longer(c("0","0.25", "0.75", "1"), names_to = "position") %>% 
  mutate(position = as.numeric(position),
         display_val = scales::percent(value, .1)) %>% 
  group_by(position) %>% 
  mutate(absolute_val = slide_dbl(value, ~{.x[1] / 2 + sum(.x[-1])}, 
                                  .after = 9)) %>% 
  ungroup() %>% 
  mutate(
    display_val = paste0("earned ", display_val, "\nof revenue"),
    display_percentile = case_when(
      percentile == "top_10" ~ "Top 10% of hosts...",
      percentile == "top_20" ~ "Next 10% of hosts...",
      TRUE ~ NA_character_))

top_host_listings <- 
  property %>% 
  filter(host_ID == host_rev[which.max(host_rev$rev),]$host_ID) %>% 
  nrow()

top_host_rev <- 
  host_rev %>% 
  filter(rev == max(rev)) %>% 
  pull(rev) %>% 
  scales::dollar(accuracy = 0.1, scale = 1 / 1000000, suffix = " million")

median_host_rev <- 
  median(host_rev$rev) %>%
  scales::dollar(accuracy = 100)

n_hosts_over_250 <- 
  host_rev %>% 
  filter(rev >= 250000) %>% 
  nrow()

host_rev_top_10 <- 
  host_rev %>% 
  summarize(top_10 = sum(rev[rev > quantile(rev, .9)]) / sum(rev)) %>% 
  pull(top_10) %>% 
  scales::percent(0.1)

host_rev_top_5 <- 
  host_rev %>% 
  summarize(top_5 = sum(rev[rev > quantile(rev, .95)]) / sum(rev)) %>% 
  pull(top_5) %>% 
  scales::percent(0.1)

host_rev_top_1 <- 
  host_rev %>% 
  summarize(top_1 = sum(rev[rev > quantile(rev, .99)]) / sum(rev)) %>% 
  pull(top_1) %>% 
  scales::percent(0.1)

#### same for 2019

host_deciles19 <-
  daily %>%
  filter(housing, date >= start_2019, date <= end_2019, 
         status == "R", !is.na(host_ID)) %>%
  group_by(host_ID) %>%
  summarize(rev = sum(price)) %>% 
  summarize(all = sum(rev),
            top_10 = sum(rev[rev > quantile(rev, c(0.90))] / all),
            top_20 = sum(rev[rev > quantile(rev, c(0.80))] / all) - 
              sum(rev[rev > quantile(rev, c(0.90))] / all),
            top_30 = sum(rev[rev > quantile(rev, c(0.70))] / all) - 
              sum(rev[rev > quantile(rev, c(0.80))] / all),
            top_40 = sum(rev[rev > quantile(rev, c(0.60))] / all) - 
              sum(rev[rev > quantile(rev, c(0.70))] / all),
            top_50 = sum(rev[rev > quantile(rev, c(0.50))] / all) - 
              sum(rev[rev > quantile(rev, c(0.60))] / all),
            top_60 = sum(rev[rev > quantile(rev, c(0.40))] / all) - 
              sum(rev[rev > quantile(rev, c(0.50))] / all),
            top_70 = sum(rev[rev > quantile(rev, c(0.30))] / all) - 
              sum(rev[rev > quantile(rev, c(0.40))] / all),
            top_80 = sum(rev[rev > quantile(rev, c(0.20))] / all) - 
              sum(rev[rev > quantile(rev, c(0.30))] / all),
            top_90 = sum(rev[rev > quantile(rev, c(0.10))] / all) - 
              sum(rev[rev > quantile(rev, c(0.20))] / all),
            top_100 = sum(rev[rev > quantile(rev, c(0.00))] / all) - 
              sum(rev[rev > quantile(rev, c(0.10))] / all)) %>% 
  select(-all) %>% 
  pivot_longer(everything(), names_to = "percentile", values_to = "value") %>% 
  mutate(percentile = factor(percentile, levels = paste0("top_", 1:10 * 10))) %>% 
  mutate(perfect_distribution = 0.1,
         decile = 1:10,
         dummy_1 = perfect_distribution,
         dummy_2 = value) %>%  
  rename("0" = perfect_distribution, "1" = value, "0.25" = dummy_1, 
         "0.75" = dummy_2) %>%
  pivot_longer(c("0","0.25", "0.75", "1"), names_to = "position") %>% 
  mutate(position = as.numeric(position),
         display_val = scales::percent(value, .1)) %>% 
  group_by(position) %>% 
  mutate(absolute_val = slide_dbl(value, ~{.x[1] / 2 + sum(.x[-1])}, 
                                  .after = 9)) %>% 
  ungroup() %>% 
  mutate(
    display_val = paste0("earned ", display_val, "\nof revenue"),
    display_percentile = case_when(
      percentile == "top_10" ~ "Top 10% of hosts...",
      percentile == "top_20" ~ "Next 10% of hosts...",
      TRUE ~ NA_character_))

top_host_listings19 <- 
  property %>% 
  filter(host_ID == host_rev[which.max(host_rev19$rev),]$host_ID) %>% 
  nrow()

top_host_rev19 <- 
  host_rev19 %>% 
  filter(rev == max(rev)) %>% 
  pull(rev) %>% 
  scales::dollar(accuracy = 0.1, scale = 1 / 1000000, suffix = " million")

median_host_rev19 <- 
  median(host_rev19$rev) %>%
  scales::dollar(accuracy = 100)

n_hosts_over_250_19 <- 
  host_rev19 %>% 
  filter(rev >= 250000) %>% 
  nrow()

host_rev_top_10_19 <- 
  host_rev19 %>% 
  summarize(top_10 = sum(rev[rev > quantile(rev, .9)]) / sum(rev)) %>% 
  pull(top_10) %>% 
  scales::percent(0.1)

host_rev_top_5_19 <- 
  host_rev19 %>% 
  summarize(top_5 = sum(rev[rev > quantile(rev, .95)]) / sum(rev)) %>% 
  pull(top_5) %>% 
  scales::percent(0.1)

host_rev_top_1_19 <- 
  host_rev19 %>% 
  summarize(top_1 = sum(rev[rev > quantile(rev, .99)]) / sum(rev)) %>% 
  pull(top_1) %>% 
  scales::percent(0.1)

diff_host_250 <- 
  n_hosts_over_250_19 - n_hosts_over_250

rm(property, daily, GH)

```

``` {r make_fig_1_6}

figure_1_6_fun <- function(regular = "", condensed = "") {
  
  revenue_colour <- colorRampPalette(col_palette[c(5, 4, 3, 6, 2, 1)])(10)

  host_deciles %>% 
  ggplot(aes(position, value, group = decile, fill = decile)) +
  geom_area(colour = "white", lwd = 1.2) +
  geom_text(aes(x = 0.02, y = absolute_val, label = display_percentile), 
            data = filter(host_deciles, position == 0, decile <= 2),
            family = regular, 
            hjust = 0) +
  geom_text(aes(x = 0.98, y = absolute_val, label = display_val), 
            data = filter(host_deciles, position == 1, decile <= 2),
            family = regular, 
            hjust = 1) +
  scale_y_continuous(name = "Host decile", label = scales::label_percent(1),
                     breaks = seq(0, 1, by = 0.1), limits = c(0, 1),
                     sec.axis = sec_axis(~., 
                                         name = "% of total revenue",
                                         labels = derive(), 
                                         breaks = derive())) +
  scale_fill_gradientn(colours = revenue_colour) +
  theme_void() +
  theme(legend.position = "none",
        text = element_text(family = regular),
        axis.text.y = element_text(hjust = 1),
        axis.title.y.left = element_text(
          angle = 90, margin = margin(0, 10, 0, 0)),
        axis.title.y.right = element_text(
          angle = 270, margin = margin(0, 0, 0, 10)),
        axis.title.x = element_blank(), 
        axis.text.x = element_blank())

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_6.pdf"), 
         plot = figure_1_6_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_6.pdf"))
}

```

Among all the STR hosts who earned revenue in the City of Toronto in 2020, the median revenue was `r median_host_rev`. Throughout the City of Toronto, there were `r n_hosts_over_250` hosts that earned more than $250,000 in 2020, which is `r diff_host_250` less hosts than in 2019. Figure \@ref(fig:fig-1-6) shows the percentage of the total `r annual_rev` in STR revenue which accrued to each decile of hosts. The figure shows that revenue is disproportionately concentrated among a small number of hosts; the top 10% earned `r host_rev_top_10`: the top 5% earned `r host_rev_top_5` of revenue, while the top 1% of hosts earned `r host_rev_top_1` of all revenue. The pandemic has thus not impacted greatly the sharp difference in revenue distribution among STR hosts. To put this revenue distribution in context, Montreal’s top 10% of STR hosts earned 68.8% of all revenue in 2019. On the other hand, Vancouver's top 10% hosts only earned 43.2% of all revenue in 2019.

``` {r fig-1-6, include = TRUE, fig.cap = '(ref:fig-1-6)', fig.align = "center"}

figure_1_6_fun()

```

(ref:fig-1-6) _STR host revenue distribution in the City of Toronto_

<br>

## The commercialization of Toronto’s STR market

Some hosts operate multiple STR units, which strongly suggests that they are commercial operators rather than a casual home sharers. To take the simplest case, a host with two or more entire-home listings on the same day cannot be operating both listings out of their principal residence. We consider entire-homes to be "multilistings" if they are operated by hosts who are simultaneously operating other entire-home listings. We define private-room multilistings as cases where a host has three or more private-room listings operating on the same day. Since `r eh_3_bedroom` of entire-home listings have three or fewer bedrooms, there will be extremely few cases where a host operating three private-room STR listings in a dwelling unit has not converted the entire unit into a dedicated STR. 

``` {r para_10, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# ML table for figure
ML <- 
  daily %>% 
  filter(status != "B") %>% 
  group_by(date) %>% 
  summarize(Listings = mean(multi),
            Revenue = sum(price[status == "R" & multi], na.rm = TRUE) / 
              sum(price[status == "R"], na.rm = TRUE)) %>% 
  mutate(across(where(is.numeric), slide_dbl, mean, .before = 13)) %>% 
  pivot_longer(c(Listings, Revenue), names_to = "Multilisting percentage",
               values_to = "value")

rm(property, daily, GH)

```

``` {r make_fig_1_7}

figure_1_7_fun <- function(regular = "", condensed = "") {
  
  ML %>% 
    filter(date >= "2017-01-01", date <= "2020-11-30") %>% 
    ggplot() +
    geom_line(aes(date, value, colour = `Multilisting percentage`), lwd = 1) +
    scale_x_date(name = NULL) +
    scale_y_continuous(name = NULL, 
                       label = scales::percent_format(accuracy = 1)) +
    scale_colour_manual(values = col_palette[c(5, 1)]) +
    theme_minimal() +
    theme(legend.position = "bottom",
          panel.grid.minor.x = element_blank(),
          text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold"),
          legend.text = element_text(family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_7.pdf"), 
         plot = figure_1_7_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_7.pdf"))
}

```

In 2020, `r ml_listings` of active listings in Toronto were multilistings, earning `r ml_revenue` of total host revenue. Multilistings had been growing steadily since 2017, both in terms of listings and revenue percentage, until the Covid-19 pandemic, when their proportion dropped somewhat (Figure \@ref(fig:fig-1-7)). Still, through the fall of 2020 multilistings were earning a bit more than 4 out of every 10 dollars on STR platforms in Toronto. 

``` {r fig-1-7, include = TRUE, fig.cap = '(ref:fig-1-7)', fig.align = "center"}

figure_1_7_fun()

```

(ref:fig-1-7) _The percentage of active listings and revenue accounted for by multilistings in Toronto (14-day average)_

These figures should be taken as highly conservative estimates. Many commercial operators will use different Airbnb or Vrbo accounts to manage their listings. If multiple listings share the same photographs then our image recognition software will be able to connect them together, but it is otherwise difficult to determine whether two accounts belong to the same person. Moreover, many STR commercial operators only operate a single listing, but operate it on a full-time basis. A house owner with a secondary suite, or the owner of an investment condo who operates a STR in it, are clearly commercial operators running listings which are not their principal residences, but they would not be counted by this method.

<br>

## Toronto in comparison with other major Canadian cities

``` {r para_9_1, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "national_comparison.qs"))}

 national_comparison <- qread(here("output", "national_comparison.qs"),
                              nthreads = availableCores())
 
 van_active_per_1000 <- 
   national_comparison %>% 
   filter(city == "Vancouver") %>% 
   pull(listings_per_1000) %>% 
   round(1) %>% 
   prettyNum(",")
 
 to_active_per_1000 <- 
   national_comparison %>% 
   filter(city == "Toronto") %>% 
   pull(listings_per_1000) %>% 
   round(1) %>% 
   prettyNum(",")
 
 van_rev_per_listing <- 
   national_comparison %>% 
   filter(city == "Vancouver") %>% 
   pull(revenue_per_listing) %>% 
   round(-2) %>% 
   scales::dollar()
 
 to_rev_per_listing <- 
   national_comparison %>% 
   filter(city == "Toronto") %>% 
   pull(revenue_per_listing) %>% 
   round(-2) %>% 
   scales::dollar()
 
van_rev_yoy <- 
  national_comparison %>% 
  filter(city == "Vancouver") %>% 
  pull(YOY_revenue) %>% 
  scales::percent(0.1)

mtl_rev_yoy <- 
  national_comparison %>% 
  filter(city == "Montreal") %>% 
  pull(YOY_revenue) %>% 
  scales::percent(0.1)

```

In 2020, Toronto had the largest STR market in the country by both active listing numbers (`r avg_listings_active`) and host revenue (`r annual_rev`), followed in both cases by Montreal and Vancouver (Table \@ref(tab:tab-1-3)). However, in relative terms, Vancouver stands considerably ahead of both Toronto and Montreal. Vancouver had the most active listings per 1000 households (`r van_active_per_1000` compared to `r to_active_per_1000` in Toronto) and the most revenue per listing (`r van_rev_per_listing` compared to `r to_rev_per_listing` in Toronto). The pandemic has hit the STR markets of the ten largest Canadian metropolises differently. Small markets such as Brampton and Hamilton have seen their daily active listings and yearly revenue decrease less than bigger markets. On the other hand, both Montreal and Vancouver have experienced drastic drops in revenue, by `r mtl_rev_yoy` and `r van_rev_yoy` respectively.

``` {r tab-1-3, include = TRUE}

 library(kableExtra)
 
 national_comparison <- qread(here("output", "national_comparison.qs"),
                              nthreads = availableCores())

national_comparison %>% 
     transmute(
       city, 
       active_daily_listings = prettyNum(round(active_daily_listings, -1), ","),
       listings_per_1000 = round(listings_per_1000, 1),
       revenue = scales::dollar(revenue, 0.1, 1/1000000),
       revenue_per_listing = scales::dollar(revenue_per_listing, 100),
       YOY_active_listings = scales::percent(YOY_active_listings, , accuracy = 0.1),
       YOY_revenue = scales::percent(YOY_revenue, accuracy = 0.1)) %>% 
     set_names(c("City", "Active listings", "Listings per 1000 households",
               "Annual revenue (million)", "Revenue per listing", 
               "YOY change in active listings", "YOY change in revenue")) %>% 
   kbl(caption = "2020 STR activity in the largest ten Canadian municipalities",
       align = "lrrrr") %>%
   kable_styling(latex_options="scale_down") %>%
   row_spec(9, background = paste0(col_palette[2], "50"))
  
```

\newpage
