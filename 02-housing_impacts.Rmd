# STR housing impacts

<style type="text/css">
  body{
  font-family: Futura, Helvetica, Arial;
}
</style>

<br>

```{r setup, include = FALSE, echo = FALSE}

###### for max to be able to knit
if (memory.limit() < 20000) {memory.limit(size = 48000)}
####

library(here)
source(here("R", "01_startup.R"))

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

# Function for checking file modifications
mtime <- function(files) lapply(Sys.glob(files), function(x) file.info(x)$mtime)

# Set this to TRUE to output PDF figures
build_figures <- TRUE

```

```{r new_objects, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())
qload(here("output", "geometry.qsm"), nthreads = availableCores())

FREH <- 
  daily %>% 
  filter(date >= "2016-01-01") %>% 
  group_by(date) %>% 
  summarize(across(c(FREH, FREH_3), sum)) %>%
  filter(substr(date, 9, 10) == "01")

FREH_WD <- 
  daily %>% 
  filter(date %in% as.Date(c("2019-12-31", "2020-12-31"))) %>% 
  group_by(ward, date) %>% 
  summarize(FREH = sum(FREH_3)) %>% 
  mutate(date = if_else(date >= start_2020, 2020, 2019))

FREH_DA <- 
  daily %>% 
  filter(date == "2020-12-01") %>% 
  left_join(select(st_drop_geometry(property), property_ID, GeoUID)) %>% 
  group_by(GeoUID) %>% 
  summarize(FREH = sum(FREH_3))

GH_WD <- 
  GH %>% 
  filter(date %in% as.Date(c("2019-12-31", "2020-12-31"))) %>% 
  mutate(geometry = st_centroid(geometry)) %>% 
  st_join(WD) %>% 
  st_drop_geometry() %>% 
  group_by(ward, date) %>% 
  summarize(GH = sum(housing_units, na.rm = TRUE)) %>% 
  as_tibble() %>% 
  mutate(date = if_else(date >= start_2020, 2020, 2019))

GH_DA <- 
  GH %>% 
  filter(date == "2020-12-31") %>% 
  mutate(geometry = st_centroid(geometry)) %>% 
  st_join(DA) %>% 
  st_drop_geometry() %>% 
  group_by(GeoUID) %>% 
  summarize(GH = sum(housing_units, na.rm = TRUE)) %>% 
  as_tibble()

FREH_total <- 
  daily %>% 
  filter(date >= "2016-01-01") %>% 
  group_by(date) %>% 
  summarize(across(c(FREH, FREH_3), sum)) %>%
  filter(substr(date, 9, 10) == "01")

GH_total <-
  GH %>%
  st_drop_geometry() %>%
  filter(status != "B") %>% 
  group_by(date) %>%
  summarize(GH = sum(housing_units)) %>%
  mutate(GH = slide_dbl(GH, mean, .before = 29))

housing_loss <-
  FREH_total %>%
  select(date, FREH_3) %>% 
  left_join(GH_total, by = "date") %>%
  rename(`Entire home/apt` = FREH_3, `Private room` = GH) %>%
  pivot_longer(c(`Entire home/apt`, `Private room`), 
               names_to = "Listing type",
               values_to = "Housing units") %>% 
  mutate(`Listing type` = factor(`Listing type`, 
                                 levels = c("Private room", "Entire home/apt")))  

housing_loss_WD <- 
  WD %>% 
  left_join(FREH_WD) %>% 
  left_join(GH_WD) %>% 
  mutate(GH = if_else(is.na(GH), 0L, GH),
         housing_loss_pct = (FREH + GH) / dwellings)

housing_loss_DA <- 
  DA %>% 
  left_join(FREH_DA) %>% 
  left_join(GH_DA) %>% 
  mutate(GH = if_else(is.na(GH), 0L, GH),
         housing_loss_pct = (FREH + GH) / dwellings)

WD_housing_table <- 
  WD %>% 
  st_drop_geometry() %>% 
  left_join(FREH_WD) %>% 
  left_join(GH_WD) %>%
  mutate(GH = if_else(is.na(GH), 0L, GH)) %>% 
  group_by(ward) %>% 
  summarize(
    dwellings = mean(dwellings),
    housing_loss_2019 = sum(FREH[date == 2019]) + sum(GH[date == 2019]),
    housing_loss_2020 = sum(FREH[date == 2020]) + sum(GH[date == 2020]),
    yoy_change = (housing_loss_2020 - housing_loss_2019) / housing_loss_2019,
    housing_loss_pct_2020 = housing_loss_2020 / dwellings)
  
rm(property, daily, GH, CMA, DA, city)

```

```{r exec_summ, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# Total housing loss for 2020
housing_loss_2020 <- 
  {{FREH %>% 
      filter(date == "2020-12-01") %>% 
      pull(FREH_3)} +
      {GH %>% 
          filter(date == "2020-12-01") %>% 
          pull(housing_units) %>% sum()}} %>% 
  round(digit = -1) %>% 
  prettyNum(",")

# Total housing loss for 2019
housing_loss_2019 <- 
  {{FREH %>% 
      filter(date == "2019-12-01") %>% 
      pull(FREH_3)} +
      {GH %>% 
          filter(date == end_2019) %>% 
          pull(housing_units) %>% sum()}} %>% 
  round(digit = -1) %>% 
  prettyNum(",")

# Absolute numbers of change in dedicated STRs from 2019 to 2020
housing_loss_change_absolute <- 
  {{{FREH %>% filter(date == as.Date("2019-12-01")) %>% pull(FREH_3)} +
      {GH %>% filter(date == as.Date("2020-12-01") - years(1)) %>% 
          pull(housing_units) %>% sum()}} -
  {{FREH %>% filter(date == as.Date("2020-12-01")) %>% pull(FREH_3)} +
      {GH %>% filter(date == as.Date("2020-12-01")) %>% pull(housing_units) %>% sum()}}} %>% 
  round(digit = -1) %>% 
  prettyNum(",")

# YOY increase in housing loss
housing_loss_change <- 
  {{{FREH %>% filter(date == as.Date("2020-12-01")) %>% pull(FREH_3)} +
      {GH %>% filter(date == as.Date("2020-12-01")) %>% pull(housing_units) %>% sum()}} /
      {{FREH %>% filter(date == as.Date("2019-12-01")) %>% pull(FREH_3)} +
          {GH %>% filter(date == as.Date("2020-12-01") - years(1)) %>% 
              pull(housing_units) %>% sum()}}} %>% 
  {. - 1} %>% 
  {. * -1} %>% 
  round(3) %>% 
  scales::percent(0.1)

housing_loss_pct_dwelling <- 
  {{{FREH %>% filter(date == "2020-12-01") %>% pull(FREH_3)} +
      {GH %>% filter(date == "2020-12-01") %>% pull(housing_units) %>% sum()}} /
      sum(WD$dwellings)} %>% 
  round(3) %>% 
  scales::percent(0.1)

# Housing loss in Spadina-Fort York, University-Rosedale, and Toronto Centre
housing_loss_pct_WD <- 
  WD %>% 
  left_join(FREH_WD) %>% 
  left_join(GH_WD) %>% 
  filter(date == "2020") %>% 
  mutate(GH = if_else(is.na(GH), 0L, GH),
         housing_loss_per_dwelling = (FREH + GH) / dwellings,
         housing_loss_per_dwelling = round(housing_loss_per_dwelling, 3)) %>% 
  st_drop_geometry() %>% 
  filter(ward %in% c("Spadina-Fort York", "University-Rosedale", "Toronto Centre"))

housing_loss_pct_spadina_2019 <- 
  WD %>% 
  left_join(FREH_WD) %>% 
  left_join(GH_WD) %>% 
  filter(date == "2019") %>% 
  mutate(GH = if_else(is.na(GH), 0L, GH),
         housing_loss_per_dwelling = (FREH + GH) / dwellings,
         housing_loss_per_dwelling = round(housing_loss_per_dwelling, 3)) %>% 
  st_drop_geometry() %>% 
  filter(ward %in% c("Spadina-Fort York")) %>% 
    pull(housing_loss_per_dwelling) %>% 
  scales::percent(0.1)

housing_loss_pct_spadina <- 
  housing_loss_pct_WD %>% 
  filter(ward == "Spadina-Fort York") %>% 
  pull(housing_loss_per_dwelling) %>% 
  scales::percent(0.1)

housing_loss_pct_university <- 
  housing_loss_pct_WD %>% 
  filter(ward == "University-Rosedale") %>% 
  pull(housing_loss_per_dwelling) %>% 
  scales::percent(0.1)

housing_loss_pct_centre <- 
  housing_loss_pct_WD %>% 
  filter(ward == "Toronto Centre") %>% 
  pull(housing_loss_per_dwelling) %>% 
  scales::percent(0.1)


rm(property, daily, GH)

```

**Prior to the Covid-19 pandemic, there were 8,300 housing units operating as dedicated STRs in Toronto. Two thirds of all entire-home listings and half of private-room listings were dedicated STRs. Because of the general collapse of STR activity in 2020, the number of dedicated STRs has fallen by `r housing_loss_change` to `r housing_loss_2020`. In the Spadina-Fort York area, `r housing_loss_pct_spadina` of all housing was operating as dedicated STRs at the end of 2020, despite the pandemic, while the figure was `r housing_loss_pct_university` in University-Rosedale and `r housing_loss_pct_centre` in Toronto Centre.**

<br>

## STR-induced housing loss

Toronto’s housing market has been under considerable stress in the past years, with housing prices and rents rising, and rental vacancy rates falling. These are symptoms of a market where the supply of housing is insufficient to meet demand. One possible explanation for both the insufficient supply and elevated demand for housing in Toronto is the growth in short-term rentals. Tourists are now able to compete with residents for housing—adding demand to the local housing market—while landlords are now able to shift their properties out of the conventional housing market to become dedicated STRs—reducing the supply of conventional housing. Research has found that renting a housing unit on the STR market frequently offers landlords greater potential revenue than conventional leases (Wachsmuth & Weisler 2018), especially in transit-accessible neighborhoods (Deboosere et al. 2019). Multiple studies have also found that Airbnb and other STR platforms increase housing costs (Barron, Kung, & Proserpio 2017; Horn & Merante 2017; Garcia-Lopez et al. 2019).

One of the major considerations when gauging the impacts of short-term rentals (STRs) on a city, therefore, is the extent to which STRs are removing long-term housing from the market. This process can occur either directly, where tenants of a unit are evicted or not replaced at the end of a lease and the unit is converted to a STR, or indirectly by absorbing new construction or investment properties which otherwise would have gone onto the long-term market. To obtain the exact number of units that have been occupied as STRs, landlords or units would need to be individually surveyed, which is infeasible because STR hosts are mostly anonymous on major STR platforms such as Airbnb and VRBO. Instead, we use the daily activity of listings, alongside structural characteristics such as listing type and location, to estimate which listings are operating as dedicated STRs and are therefore not available as conventional long-term housing.

_Frequently Rented Entire-Home (FREH) listings:_ The number of frequently-rented units is one way to estimate STR-induced housing loss. If a STR is available for reservations the majority of the year and receives many bookings, it is reasonable to assume that it is not serving as an individual’s principal residence at the same time. Along these lines, we define frequently rented entire-home (FREH) listings as entire-home listings which were available on Airbnb or VRBO the majority of the year (at least 183 nights) and were booked a minimum of 90 nights. We then apply a statistical model (described in the appendix) to the FREH data in order to generate an estimate of FREH activity based on three months of listing activity. This allows us to detect listings which are operating in a full-time manner but have not yet been listed for an entire year, and allows us to account for relatively short-term changes in market conditions.

_Ghost hostels:_ In addition to FREH listings, it is possible that entire housing units have been subdivided into multiple private-room listings, each of which appearing to be a spare bedroom or the like, while actually collectively representing an apartment removed from the long-term housing market. We call these clusters of private-room listings “ghost hostels”, building on the advocacy group Fairbnb.ca’s term “ghost hotels”—multiple FREH listings located in a single building, collectively serving as de facto hotels instead of long-term housing (Wieditz 2017). We detect ghost hostels by finding clusters of three or more private-room listings operated by a single host, whose reported locations are close enough to each other that they are likely to have originated in the same actual housing unit. (Airbnb and VRBO obfuscate listing locations by shifting them randomly up to 200 m.)

```{r para_1, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# FREH in 2020-10
FREH_2020 <- 
  FREH %>% 
  filter(date == "2020-12-01") %>% 
  pull(FREH_3) %>% 
  round(digit = -1) %>% 
  prettyNum(",")

# GH in 2020-10
GH_2020 <- 
  GH %>% 
  filter(date == "2020-12-01") %>% 
  pull(housing_units) %>% 
  sum() %>% 
  round(digit = -1) %>% 
  prettyNum(",")

# Change in listings
active_yoy_change <- 
  daily %>% 
  filter(housing, status != "B", date >= start_2020 - years(1), 
         date <= end_2020) %>% 
  group_by(year_2020 = date >= start_2020) %>% 
  summarize(active_listings = n() / 365,
            revenue = sum(price[status == "R"]), .groups = "drop") %>% 
  summarize(across(c(active_listings, revenue), ~{(.x[2] - .x[1]) / .x[1]}),
            .groups = "drop")

# YOY listing change
active_yoy_listings <- 
  active_yoy_change$active_listings %>% 
  {. * -1} %>% 
  scales::percent(accuracy = 0.1)

# Total housing loss for 2020
housing_loss_2020 <- 
  {{FREH %>% 
      filter(date == "2020-12-01") %>% 
      pull(FREH_3)} +
    {GH %>% 
        filter(date == "2020-12-01") %>% 
        pull(housing_units) %>% 
        sum()}} %>% 
  round(digit = -1) %>% 
  prettyNum(",")

rm(property, daily, GH)

```

``` {r make_fig_2_1}

figure_2_1_fun <- function(regular = "", condensed = "") {
  
housing_loss %>% 
  ggplot(aes(date, `Housing units`, fill = `Listing type`)) +
  geom_col(lwd = 0) +
  scale_fill_manual(values = col_palette[c(2, 4)]) +
  scale_x_date(name = NULL, limits = c(as.Date("2016-10-01"), NA)) +
  scale_y_continuous(name = NULL, label = scales::comma) +
  theme_minimal() +
  theme(legend.position = "bottom", 
        panel.grid.minor.x = element_blank(),
        text = element_text(face = "plain", family = regular),
        legend.title = element_text(face = "bold", family = regular, 
                                    size = 10),
        legend.text = element_text( size = 10, family = regular))
  
}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_1.pdf"), 
         plot = figure_2_1_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_2_1.pdf"))
}

```

At the end of 2020, there were `r FREH_2020` FREH listings in the City of Toronto, and `r GH_2020` more housing units which were operating as ghost hostels. In total, therefore, short-term rentals were taking `r housing_loss_2020` housing units off of Toronto’s long-term market at the end of the year (Figure \@ref(fig:fig-2-1)). Notably, while the number of active daily listings declined by `r active_yoy_listings` over 2020, the number of housing units which STRs took off of Toronto’s housing market decreased at a much sharper rate. There were `r housing_loss_change` fewer dedicated STRs in 2020 compared to 2019, from `r housing_loss_2019` to `r housing_loss_2020`. This high decline in commercially-operated STRs reflects that the pandemic has disproportionately affected commercial operators in the City.


``` {r fig-2-1, include = TRUE, fig.cap = '(ref:fig-2-1)', fig.align = "center"}

figure_2_1_fun()

```

(ref:fig-2-1) _Housing units converted to dedicated STRs in the City of Toronto (monthly average)_

```{r para_2, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

# End-of-year summaries
housing_loss_summaries <- 
  daily %>% 
  filter(housing, status != "B", listing_type %in% c("Entire home/apt",
                                                     "Private room")) %>% 
  group_by(date) %>% 
  summarize(eh = mean(FREH_3[listing_type == "Entire home/apt"] > 0.5),
            pr = mean(GH[listing_type == "Private room"])) %>% 
  mutate(across(c(eh, pr), slide_dbl, mean, .before = 30)) %>% 
  filter(date %in% as.Date(c("2016-12-31", "2019-12-31", "2020-12-31")))

eh_housing_loss <- 
  housing_loss_summaries %>% 
  filter(date == "2020-12-31") %>% 
  pull(eh) %>% 
  scales::percent(0.1)

pr_housing_loss <- 
  housing_loss_summaries %>% 
  filter(date == "2020-12-31") %>% 
  pull(pr) %>% 
  scales::percent(0.1)

eh_housing_loss_2019 <- 
  housing_loss_summaries %>% 
  filter(date == "2019-12-31") %>% 
  pull(eh) %>% 
  scales::percent(0.1)

pr_housing_loss_2019 <- 
  housing_loss_summaries %>% 
  filter(date == "2019-12-31") %>% 
  pull(pr) %>% 
  scales::percent(0.1)

eh_housing_loss_2016 <- 
  housing_loss_summaries %>% 
  filter(date == "2016-12-31") %>% 
  pull(eh) %>%
  scales::percent(0.1)

pr_housing_loss_2016 <- 
  housing_loss_summaries %>% 
  filter(date == "2016-12-31") %>% 
  pull(pr) %>% 
  scales::percent(0.1)

# Table for figure
housing_loss_share <- 
  daily %>% 
  filter(housing, status != "B", listing_type %in% c("Entire home/apt",
                                                     "Private room")) %>% 
  group_by(date) %>% 
  summarize(
    `Entire home/apt` = mean(FREH_3[listing_type == "Entire home/apt"] > 0.5),
    `Private room` = mean(GH[listing_type == "Private room"])) %>% 
  filter(date >= "2016-10-01") %>% 
  pivot_longer(-date, names_to = "Listing type", 
               values_to = "housing_loss_pct") %>% 
  group_by(`Listing type`) %>% 
  mutate(housing_loss_pct = slide_dbl(housing_loss_pct, mean, .before = 13))

rm(property, daily, GH)

```

``` {r make_fig_2_2}

figure_2_2_fun <- function(regular = "", condensed = "") {
  
  housing_loss_share %>% 
    ggplot(aes(date, housing_loss_pct, colour = `Listing type`)) +
    geom_line(lwd = 1) +
    scale_x_date(name=NULL) +
    scale_y_continuous(name = NULL, labels = scales::percent) +
    scale_colour_manual(values = col_palette[c(5, 1)]) +
    theme_minimal() +
    theme(legend.position = "bottom",
          panel.grid.minor.x = element_blank(),
          text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold"),
          legend.text = element_text(family = regular))
  
}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_2.pdf"), 
         plot = figure_2_2_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_2_2.pdf"))
}

```

In 2019, two thirds of entire-home listings (`r eh_housing_loss_2019`) and half (`r pr_housing_loss_2019`) of the private-room listings were taking housing off the long-term market. At the end of 2020 only a quarter (`r eh_housing_loss`) of entire-home listings and less than half of (`r pr_housing_loss`) private-room listings were being operated in a full-time or close-to-full-time fashion (Figure \@ref(fig:fig-2-2)). This does not mean that these listings are no longer dedicated STRs—a possibility we explore below—since they could still be operating full-time but simply not receiving many reservations due to Covid travel restrictions. Table \@ref(tab:tab-2-1) summarizes STR-induced housing loss patterns by neighbourhood. It demonstrates that the City-wide trend of shrinking dedicated STRs due to the pandemic holds in all neighbourhoods. The year-over-year decline in STR-induced housing loss has been evenly distributed between virtually all wards, with an average of -59.3%. The following section takes a closer look at the impact of Covid-19 on frequently rented entire-home listings.


``` {r fig-2-2, include = TRUE, fig.cap = '(ref:fig-2-2)', fig.align = "center"}

figure_2_2_fun()

```

(ref:fig-2-2) _The percentage of active STR listings contributing to housing loss each day in Toronto (14-day average)_

``` {r tab-2-1, include = TRUE}

library(kableExtra)

WD_housing_table %>% 
  summarize(
    dwellings = sum(dwellings),
    housing_loss_2019 = sum(housing_loss_2019),
    housing_loss_2020 = sum(housing_loss_2020),
    yoy_change = (housing_loss_2020 - housing_loss_2019) / housing_loss_2019,
    housing_loss_pct_2020 = housing_loss_2020 / dwellings) %>% 
  mutate(ward = "City of Toronto") %>% 
  bind_rows(WD_housing_table) %>% 
  relocate(ward) %>% 
  select(-dwellings) %>% 
  filter(housing_loss_2020 > 50) %>% 
  mutate(across(c(housing_loss_2019, housing_loss_2020), round, -1)) %>% 
  mutate(across(c(yoy_change, housing_loss_pct_2020), round, 4)) %>% 
  arrange(desc(housing_loss_2020)) %>%
  rename(Ward = ward,
         `Housing loss (2020)` = housing_loss_2020,
         `Housing loss (2019)` = housing_loss_2019,
         `Annual growth (%)` = yoy_change,
         `% of housing lost (2020)` = housing_loss_pct_2020) %>% 
  kbl(caption = paste0("STR-induced housing loss by ward in the City ", 
                       "of Toronto (for wards with at least 50 housing ",
                       "units lost in 2020)"),
      align = "lrrrr") %>%
  kable_styling(latex_options = "scale_down") %>%
  row_spec(1, background = paste0(col_palette[2], "50"))

```

```{r para_3, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "cmhc.qsm"), nthreads = availableCores())

# Vacancy rate downtown (Toronto (Central))
downtown_spadina <- 
  annual_vacancy %>% 
  filter(dwelling_type == "Total",
         bedroom == "Total",
         zone %in% c(1),
         !is.na(vacancy)) %>% 
  group_by(zone) %>% 
  filter(date == max(date)) %>% 
  ungroup() %>% 
  pull(vacancy) %>% 
  scales::percent(0.1)

```

```{r on_water, cache = TRUE, cache.lazy = FALSE}

qload(here("output", "geometry.qsm"), nthreads = availableCores())

ocean <- 
  read_sf(here("data", "shapefiles", "lhy_000h16a_e.shp")) %>% 
  st_transform(32617)

ocean <- 
  ocean %>% 
  st_filter(rbind(select(CMA, -everything()), select(city, -everything())))

river <- 
  read_sf(here("data", "shapefiles", "lhy_000c16a_e.shp")) %>% 
  st_transform(32617)

river <- 
  river %>% 
  st_filter(rbind(select(CMA, -everything()), select(city, -everything())))

water <- rbind(select(river, -everything()), select(ocean, -everything()))

rm(ocean, river, city, CMA)
```

``` {r make_fig_2_3}

figure_2_3_fun <- function(regular = "", condensed = "") {
  
  left_map <- 
    housing_loss_WD %>% 
    filter(date=="2020") %>% 
    ggplot() +
    geom_sf(data = province, colour = "transparent", fill = "grey93") +
    geom_sf(aes(fill = housing_loss_pct), colour = "white") +
    geom_sf(data = water, fill = "white", colour = "transparent") +
    scale_fill_gradientn(colors = col_palette[c(3, 4, 5)], 
                         na.value = "grey80",
                         limits = c(0, 0.03), oob = scales::squish, 
                         labels = scales::percent)  +
    guides(fill = guide_colourbar(title = "% housing\nlost to STR",
                                  title.vjust = 1)) + 
    gg_bbox(housing_loss_DA) +
    theme_void() +
    theme(text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold", 
                                      size = 7),
          legend.title.align = 0.9,
          legend.text = element_text(family = regular, size = 5))
  
  right_map <- 
    housing_loss_DA %>% 
    ggplot() +
    geom_sf(data = province, colour = "transparent", fill = "grey93") +
    geom_sf(aes(fill = housing_loss_pct), colour = "transparent") +
    geom_sf(data = water, fill = "white", colour = "transparent") +
    scale_fill_gradientn(colors = col_palette[c(3, 4, 5)], 
                         na.value = "grey80",
                         limits = c(0, 0.05), oob = scales::squish, 
                         labels = scales::percent)  +
    guides(fill = guide_colourbar(title = "% housing\nlost to STR",
                                  title.vjust = 1)) + 
    gg_bbox(housing_loss_DA) +
    theme_void() +
    theme(text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold", 
                                      size = 7),
          legend.title.align = 0.9,
          legend.text = element_text(family = regular, size = 5))
  
  left_map + right_map + plot_layout(guides = 'collect') & 
    theme(legend.position = "bottom")

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_3.pdf"), 
         plot = figure_2_3_fun("Futura", "Futura Condensed"), 
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_2_3.pdf"))
}

```

The `r housing_loss_2020` housing units taken off of Toronto’s housing market in 2020 are `r housing_loss_pct_dwelling` of the total amount of housing in the city, and this housing loss has been concentrated in small parts of the city. Figure \@ref(fig:fig-2-3) shows the proportion of each ward or dissemination area’s housing stock which was operated as a dedicated short-term rental as of the end of 2020. The maps show a tale of two cities: in most of Toronto, there are relatively few dedicated STRs, while in the center of the city as well as a few transit corridors, they are ubiquitous. In the Spadina-Fort York ward, `r housing_loss_pct_spadina` of all housing units were operating as dedicated STRs at the end of 2020, even in the face of Covid-19. The figure is `r housing_loss_pct_university` for University-Rosedale and `r housing_loss_pct_centre` for Toronto Centre. In the Downtown CMHC zone, the rental vacancy rate was `r downtown_spadina` in 2019, while the number of STRs contributing to housing loss in the Spadina-Fort York in 2019 was `r housing_loss_pct_spadina_2019`. This means that there were slightly more dedicated STRs in this neighbourhood than there were vacant apartments for rent. (2020 rental vacancy rates numbers were not yet available at the time of analysis.)

``` {r fig-2-3, include = TRUE, fig.cap = '(ref:fig-2-3)', fig.align = "center"}

figure_2_3_fun()

```

(ref:fig-2-3) _The percentage of housing units converted to dedicated STRs in the City of Toronto, by ward (L) and dissemination area (R)_

## Covid’s impact on frequently rented entire-home listings

```{r FREH_outcomes, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

FREH_2020 <- 
  daily %>% 
  filter(housing, date >= start_2020, date <= "2020-02-29", FREH_3 > 0.5) %>% 
  pull(property_ID) %>% 
  unique() %>% 
  {filter(property, property_ID %in% .)} %>% 
  st_drop_geometry()

non_FREH_2020 <- 
  property %>% 
  st_drop_geometry() %>% 
  filter(property_ID %in% {daily %>% 
      filter(housing, date >= start_2020, date <= "2020-02-29", 
             status != "B") %>% 
      pull(property_ID) %>% 
      unique()}, !property_ID %in% FREH_2020$property_ID)

FREH_2019 <- 
  daily %>% 
  filter(housing, date >= "2019-01-01", date <= "2019-02-28", FREH_3 > 0.5) %>% 
  pull(property_ID) %>% 
  unique() %>% 
  {filter(property, property_ID %in% .)} %>% 
  st_drop_geometry()

non_FREH_2019 <- 
  property %>% 
  st_drop_geometry() %>% 
  filter(property_ID %in% {daily %>% 
      filter(housing, date >= "2019-01-01", date <= "2019-02-28", 
             status != "B") %>% 
      pull(property_ID) %>% 
      unique()}, !property_ID %in% FREH_2019$property_ID)

total_2020 <- 
  tibble(
    group = c("FREH", "non-FREH"),
    year = 2020,
    variable = "total listings",
    value = c(nrow(FREH_2020), nrow(non_FREH_2020))
  )

total_2019 <- 
  tibble(
    group = c("FREH", "non-FREH"),
    year = 2019,
    variable = "total listings",
    value = c(nrow(FREH_2019), nrow(non_FREH_2019))
  )

deactivated_2020 <- 
  tibble(
    group = c("FREH", "non-FREH"),
    year = 2020,
    variable = "deactivated",
    value = c({
      FREH_2020 %>% 
        summarize(total = sum(scraped <= "2020-12-31")) %>% 
        pull(total)}, {
          non_FREH_2020 %>% 
            summarize(total = sum(scraped <= "2020-12-31")) %>% 
            pull(total)})
  )

deactivated_2019 <- 
  tibble(
    group = c("FREH", "non-FREH"),
    year = 2019,
    variable = "deactivated",
    value = c({
      FREH_2019 %>% 
        summarize(total = sum(scraped <= "2019-12-31")) %>% 
        pull(total)}, {
          non_FREH_2019 %>% 
            summarize(total = sum(scraped <= "2019-12-31")) %>% 
            pull(total)})
  )

blocked_PIDs_2020 <- 
  daily %>% 
  filter(housing, date >= "2020-12-01", date <= "2020-12-31") %>% 
  group_by(property_ID) %>% 
  filter(mean(status == "B") == 1) %>% 
  pull(property_ID) %>% 
  unique()

blocked_PIDs_2019 <- 
  daily %>% 
  filter(housing, date >= "2019-12-01", date <= "2019-12-31") %>% 
  group_by(property_ID) %>% 
  filter(mean(status == "B") == 1) %>% 
  pull(property_ID) %>% 
  unique()

blocked_2020 <-
  tibble(
    group = c("FREH", "non-FREH"),
    year = 2020,
    variable = "blocked",
    value = c(nrow(filter(FREH_2020, property_ID %in% blocked_PIDs_2020)),
              nrow(filter(non_FREH_2020, property_ID %in% blocked_PIDs_2020)))
  )

blocked_2019 <-
  tibble(
    group = c("FREH", "non-FREH"),
    year = 2019,
    variable = "blocked",
    value = c(nrow(filter(FREH_2019, property_ID %in% blocked_PIDs_2019)),
              nrow(filter(non_FREH_2019, property_ID %in% blocked_PIDs_2019)))
  )

active_2020 <- 
  tibble(
    group = c("FREH", "non-FREH"),
    year = 2020,
    variable = "active",
    value = c(
      nrow(FREH_2020) - deactivated_2020[1,]$value - blocked_2020[1,]$value,
      nrow(non_FREH_2020) - deactivated_2020[2,]$value - blocked_2020[2,]$value)
  )

active_2019 <- 
  tibble(
    group = c("FREH", "non-FREH"),
    year = 2019,
    variable = "active",
    value = c(
      nrow(FREH_2019) - deactivated_2019[1,]$value - blocked_2019[1,]$value,
      nrow(non_FREH_2019) - deactivated_2019[2,]$value - blocked_2019[2,]$value)
  )

comparison_df <- 
  bind_rows(total_2020, total_2019, deactivated_2020, deactivated_2019,
            blocked_2020, blocked_2019, active_2020, active_2019)

# Figure parameters
n_segs <- 1000
offset <- 1000
max_y <- comparison_df %>% filter(value == max(value)) %>% 
  mutate(value = value + 2 * offset) %>% pull(value)

fig_polys <- 
  comparison_df %>% 
  group_by(group, year, variable) %>%
  summarize(
    x = c(3, 5) - (variable == "total listings") * 3,
    ymax = rep(value, 2)) %>% 
  ungroup() %>% 
  arrange(desc(variable)) %>% 
  group_by(group, year) %>% 
  mutate(
    ymin = case_when(
      variable == "total listings" ~ offset,
      variable == "active"         ~ 0,
      variable == "blocked"        ~ ymax[variable == "active"][1] + offset,
      variable == "deactivated"    ~ ymax[variable == "blocked"][1] + 
        ymax[variable == "active"][1] + offset * 2
    ),
    ymax = ymax + ymin, .before = ymax) %>% 
  mutate(adjustment = max_y / 2 - mean(c(ymax[variable == "total listings"], 
                                         ymin[variable == "total listings"])),
         ymin = ymin + adjustment,
         ymax = ymax + adjustment) %>% 
  ungroup()

fig_segments <-
  fig_polys %>% 
  filter(variable != "total listings") %>% 
  mutate(orientation = case_when(
    variable == "deactivated" ~ -1,
    variable == "blocked"     ~ 0,
    variable == "active"      ~ 1)) %>% 
  group_by(group, year, variable) %>% 
  mutate(across(c(ymin, ymax), ~{.x + c(offset, 0) * orientation})) %>% 
  ungroup() %>% 
  select(-orientation) %>% 
  mutate(x = (x + 1) / 2) %>% 
  group_by(group, year) %>% 
  mutate(ramp = 1:6) %>% 
  group_by(group, year, variable) %>% 
  mutate(ymin_slope = diff(ymin) / diff(x),
         ymin_intercept = ymin[1] - ymin_slope * x[1],
         ymax_slope = diff(ymax) / diff(x),
         ymax_intercept = ymax[1] - ymax_slope * x[1]) %>% 
  summarize(
    x = seq(min(x), max(x), length.out = n_segs),
    xend = x,
    y = x * ymin_slope[1] + ymin_intercept[1],
    yend = xend * ymax_slope[1] + ymax_intercept[1],
    ramp = x - min(x) + min(ramp)
  ) %>% 
  ungroup()

fig_labels <-
  fig_polys %>% 
  group_by(group, year, variable) %>% 
  summarize(x = mean(x),
            y = mean(c(ymin, ymax)),
            label = mean(ymax) - mean(ymin)) %>% 
  ungroup() %>% 
  group_by(group, year) %>% 
  mutate(label = case_when(
    variable == "total listings" ~ paste0(label, " ", variable, "\nin Jan/Feb"),
    variable == "active" ~ paste0(label, " (", 
                                  round(label/sum(label) * 200, 1), "%) ", 
                                  variable, "\nin December"),
    TRUE ~ paste0(label, " (", round(label/sum(label) * 200, 1), "%) ",
                  variable))) %>% 
  ungroup()

# Facts about housing loss
GH_total <- 
  GH %>% 
  st_drop_geometry() %>% 
  filter(status != "B") %>% 
  group_by(date) %>% 
  summarize(GH_units = sum(housing_units))

housing_loss_summary <- 
  daily %>% 
  group_by(date) %>% 
  summarize(FREH = sum(FREH_3)) %>% 
  left_join(GH_total) %>% 
  mutate(housing_loss = FREH + GH_units) %>% 
  filter(date >= start_2019) %>% 
  filter(housing_loss == max(housing_loss, na.rm = TRUE)) %>% 
  mutate(across(-date, round, -1))

peak_housing_loss <- 
  prettyNum(housing_loss_summary$housing_loss, ",")

peak_FREH <- 
  prettyNum(housing_loss_summary$FREH, ",")

peak_GH <-
  prettyNum(housing_loss_summary$GH_units, ",")

oct_2020_housing_loss <- 
  daily %>% 
  group_by(date) %>% 
  summarize(FREH = sum(FREH_3)) %>% 
  left_join(GH_total) %>% 
  mutate(housing_loss = FREH + GH_units) %>% 
  filter(date == "2020-10-01") %>% 
  mutate(across(-date, round, -1)) %>% 
  pull(housing_loss) %>% 
  prettyNum(",")

#' FREH in either Jan or Feb 2020
FREH_in_jan_feb <- 
  daily %>% 
  filter(housing, date >= "2020-01-01", date <= "2020-02-29", FREH_3 > 0.5) %>% 
  pull(property_ID) %>% 
  unique()

jan_feb_FREH_total <- 
  length(FREH_in_jan_feb) %>% 
  round(-1) %>% 
  prettyNum(",")

jan_feb_FREH_deactivated <- 
  property %>% 
  st_drop_geometry() %>% 
  filter(property_ID %in% FREH_in_jan_feb) %>% 
  summarize(total = round(sum(scraped <= "2020-12-31"), -1),
            pct = round(mean(scraped <= "2020-12-31"), 3)) %>% 
  pull(total) %>% 
  prettyNum(",")

jan_feb_FREH_deactivated_pct <- 
  property %>% 
  st_drop_geometry() %>% 
  filter(property_ID %in% FREH_in_jan_feb) %>% 
  summarize(total = round(sum(scraped <= "2020-12-31"), -1),
            pct = round(mean(scraped <= "2020-12-31"), 3)) %>% 
  pull(pct) %>% 
  scales::percent(0.1)

FREH_in_jan_feb_2019 <- 
  daily %>% 
  filter(housing, date >= "2019-01-01", date <= "2019-02-28", FREH_3 > 0.5) %>% 
  pull(property_ID) %>% 
  unique()

jan_feb_FREH_deactivated_pct_2019 <- 
  property %>% 
  st_drop_geometry() %>% 
  filter(property_ID %in% FREH_in_jan_feb_2019) %>% 
  summarize(pct = mean(scraped <= "2019-12-31")) %>% 
  pull(pct) %>% 
  scales::percent(0.1)

jan_feb_non_FREH_deactivated_pct <- 
  property %>% 
  st_drop_geometry() %>% 
  filter(property_ID %in% {daily %>% 
      filter(housing, date >= "2020-01-01", date <= "2020-02-29", 
             status != "B") %>% 
      pull(property_ID) %>% 
      unique()}, !property_ID %in% FREH_in_jan_feb) %>% 
  summarize(pct = mean(scraped <= "2020-12-31")) %>% 
  pull(pct) %>% 
  scales::percent(0.1)

jan_feb_non_FREH_deactivated_pct_2019 <- 
  property %>% 
  st_drop_geometry() %>% 
  filter(property_ID %in% {daily %>% 
      filter(housing, date >= "2019-01-01", date <= "2019-02-28", 
             status != "B") %>% 
      pull(property_ID) %>% 
      unique()}, !property_ID %in% FREH_in_jan_feb_2019) %>% 
  summarize(pct = mean(scraped <= "2019-12-31")) %>% 
  pull(pct) %>% 
  scales::percent(0.1)

# For final figure
monthly_reservation_trajectories <- 
  daily %>% 
  filter(housing, status == "R", date >= "2019-01-01", 
         listing_type == "Entire home/apt") %>% 
  mutate(FREH_feb = if_else(property_ID %in% FREH_in_jan_feb, TRUE, FALSE)) %>% 
  tsibble::as_tsibble(index = date, key = property_ID) %>% 
  tsibble::group_by_key() %>% 
  tsibble::index_by(yearmon = tsibble::yearmonth(date)) %>% 
  summarize(n = sum(status == "R"),
            FREH_feb = as.logical(prod(FREH_feb))) %>% 
  group_by(FREH_feb) %>% 
  tsibble::index_by(yearmon) %>% 
  summarize(n = mean(n)) %>% 
  arrange(yearmon, FREH_feb)

daily_reservation_trajectories <- 
  daily %>% 
  filter(housing, status == "R", date >= "2019-01-01", 
         listing_type == "Entire home/apt") %>% 
  mutate(FREH_feb = if_else(property_ID %in% FREH_in_jan_feb, TRUE, FALSE)) %>% 
  count(date, FREH_feb)

jan_feb_FREH_active <- 
  property %>% 
  filter(property_ID %in% FREH_in_jan_feb, scraped > "2020-12-31") %>% 
  nrow() %>% 
  round(-1) %>% 
  prettyNum(",")

jan_feb_FREH_blocked_all <- 
  daily %>% 
  filter(housing, date >= "2020-12-01", date <= "2020-12-31") %>% 
  group_by(property_ID) %>% 
  filter(mean(status == "B") == 1) %>% 
  pull(property_ID) %>% 
  unique() %>% 
  {filter(property, property_ID %in% ., property_ID %in% FREH_in_jan_feb)} %>% 
  nrow() %>% 
  round(-1) %>% 
  prettyNum(",")

jan_feb_FREH_blocked_all_pct <- 
  {daily %>% 
  filter(housing, date >= "2020-12-01", date <= "2020-12-31") %>% 
  group_by(property_ID) %>% 
  filter(mean(status == "B") == 1) %>% 
  pull(property_ID) %>% 
  unique() %>% 
  {filter(property, property_ID %in% ., property_ID %in% FREH_in_jan_feb)} %>% 
  nrow() %>% 
  `/`(property %>% 
        filter(property_ID %in% FREH_in_jan_feb, scraped > "2020-12-31") %>% 
        nrow())} %>% 
  scales::percent(0.1)

jan_feb_FREH_blocked_maj <- 
  daily %>% 
  filter(housing, date >= "2020-12-01", date <= "2020-12-31") %>% 
  group_by(property_ID) %>% 
  filter(mean(status == "B") > 0.5) %>% 
  pull(property_ID) %>% 
  unique() %>% 
  {filter(property, property_ID %in% ., property_ID %in% FREH_in_jan_feb)} %>% 
  nrow() %>% 
  round(-1) %>% 
  prettyNum(",")

jan_feb_FREH_blocked_maj_pct <- 
  {daily %>% 
    filter(housing, date >= "2020-12-01", date <= "2020-12-31") %>% 
    group_by(property_ID) %>% 
    filter(mean(status == "B") > 0.5) %>% 
    pull(property_ID) %>% 
    unique() %>% 
    {filter(property, property_ID %in% ., property_ID %in% FREH_in_jan_feb)} %>% 
    nrow() %>% 
    `/`(property %>% 
          filter(property_ID %in% FREH_in_jan_feb, scraped > "2020-12-31") %>% 
          nrow())} %>% 
  scales::percent(0.1)

jan_feb_FREH_blocked_all_pct_2019 <- 
  {daily %>% 
    filter(housing, date >= "2019-12-01", date <= "2019-12-31") %>% 
    group_by(property_ID) %>% 
    filter(mean(status == "B") == 1) %>% 
    pull(property_ID) %>% 
    unique() %>% 
    {filter(property, property_ID %in% ., 
            property_ID %in% FREH_in_jan_feb_2019)} %>% 
    nrow() %>% 
    `/`(property %>% 
          filter(property_ID %in% FREH_in_jan_feb_2019, 
                 scraped > "2019-12-31") %>% 
          nrow())} %>% 
  scales::percent(0.1)

jan_feb_FREH_blocked_maj_pct_2019 <- 
  {daily %>% 
    filter(housing, date >= "2019-12-01", date <= "2019-12-31") %>% 
    group_by(property_ID) %>% 
    filter(mean(status == "B") > 0.5) %>% 
    pull(property_ID) %>% 
    unique() %>% 
    {filter(property, property_ID %in% ., 
            property_ID %in% FREH_in_jan_feb_2019)} %>% 
    nrow() %>% 
    `/`(property %>% 
          filter(property_ID %in% FREH_in_jan_feb_2019, 
                 scraped > "2019-12-31") %>% 
          nrow())} %>% 
  scales::percent(0.1)

feb_2020_FREH_pct <- 
  daily %>% 
  filter(housing, date >= "2020-02-01", date <= "2020-02-29", status == "R") %>% 
  summarize(pct = mean(property_ID %in% FREH_in_jan_feb)) %>% 
  pull(pct) %>% 
  scales::percent(0.1)

rm(property, daily, GH)

```

The number of housing units in Toronto lost due to commercial STRs reached its all-time peak (`r peak_housing_loss`) at the end of 2019. Most of these (`r peak_FREH`) were FREH listings, with the remainder (`r peak_GH`) being ghost hostels—clusters of private-room listings operated out of a single housing unit. During the fall of 2020, the number of FREH listings had dropped to its lowest amount since we began tracking it in 2016, with just `r oct_2020_housing_loss` listings in October displaying availability and reservations consistent with historical patterns of full-time STR activity in Toronto.

One possibility is that these formerly FREH listings are no longer operating as STRs, either permanently (the listings were deactivated) or temporarily (the listings were blocked from receiving reservations). Under this possibility the listings may have been returned to the longer-term rental market. Another possibility is that the listings have remained open for business as short-term rentals, but the dramatically decreased demand for tourist accommodations means that the listings have not received the level of reservations which our statistical model expects in order to classify the listings as frequently rented.

``` {r make_fig_2_4}

figure_2_4_fun <- function(regular = "", condensed = "") {
  
  fig_polys %>% 
    ggplot() +
    geom_ribbon(aes(x = x, ymin = ymin, ymax = ymax, fill = variable)) +
    geom_segment(aes(x = x, xend = xend, y = y, yend = yend, group = variable,
                     colour = ramp), data = fig_segments, inherit.aes = FALSE) +
    geom_text(aes(x, y, group = variable, label = label), data = fig_labels,
              colour = "white", size = 2, family = regular) + 
    scale_colour_gradientn(colours = col_palette[c(5, 4, 5, 2, 5, 1)]) +
    scale_fill_manual(values = c("total listings" = col_palette[5], 
                                 "active" = col_palette[1],
                                 "blocked" = col_palette[2],
                                 "deactivated" = col_palette[4])) +
    facet_grid(rows = vars(group), cols = vars(year), switch = "y",
               scales = "free_y", space = "free_y") +
    theme_void() +
    theme(legend.position = "none",
          text = element_text(face = "plain", family = regular),
          strip.text = element_text(face = "bold", family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_4.pdf"), 
         plot = figure_2_4_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_2_4.pdf"))
}

```

We adjudicate between these possibilities by comparing the activity of listings which had FREH status in January or February 2020—the months before the pandemic arrived—and listings which did not have this status. There were `r jan_feb_FREH_total` listings which we consider likely to have been FREH in either or both of January and February 2020. Of these listings, `r jan_feb_FREH_deactivated` were no longer listed on Airbnb or VRBO as of December 31, 2020. This is `r jan_feb_FREH_deactivated_pct` of these listings—almost twice as high as the `r jan_feb_FREH_deactivated_pct_2019` of listings which were FREH in either January or February 2019 and were no longer listed on the STR platforms by the end of August 2019. In total, `r jan_feb_non_FREH_deactivated_pct` of non-FREH listings active in January or February 2020 were deactivated by the end of December 2020, while the corresponding figure last year was `r jan_feb_non_FREH_deactivated_pct_2019`. This means that non-FREH listings have been deactivated at a higher rate this year than last year, but FREH listings have been deactivated at a substantially higher rate this year than last year (Figure \@ref(fig:fig-2-4)).

``` {r fig-2-4, include = TRUE, fig.cap = '(ref:fig-2-4)', fig.align = "center"}

figure_2_4_fun()

```

(ref:fig-2-4) _Activity trajectories of FREH and non-FREH listings in 2019 and 2020_

Of the `r jan_feb_FREH_active` FREH listings which remained listed throughout March - December, `r jan_feb_FREH_blocked_all` (`r jan_feb_FREH_blocked_all_pct`) were blocked (i.e. not available for reservations) for all of the month of December, and `r jan_feb_FREH_blocked_maj` (`r jan_feb_FREH_blocked_maj_pct`) were blocked for a majority of the month. This is extremely rare behaviour for a dedicated STR listing, since December is usually one of the busiest months for tourist accommodations in Toronto. In 2019, only `r jan_feb_FREH_blocked_all_pct_2019` of listings which were FREH in January or February were blocked for all of December, and only `r jan_feb_FREH_blocked_maj_pct_2019` were blocked for a majority of the month.

``` {r make_fig_2_5}

library(tsibble)

figure_2_5_fun <- function(regular = "", condensed = "") {
  
  fig_left <- 
    daily_reservation_trajectories %>% 
    group_by(FREH_feb) %>% 
    mutate(n = slider::slide_dbl(n, mean, .before = 13)) %>% 
    ungroup() %>% 
    ggplot(aes(date, n, colour = FREH_feb)) +
    geom_line(lwd = 1) +
    scale_x_date(name = NULL) +
    scale_y_continuous(name = "Total daily reservations", limits = c(0, NA), 
                       label = scales::comma) +
    scale_color_manual(name = "FREH status in January-February 2020", 
                       values = col_palette[c(5, 1)]) +
    theme_minimal() +
    theme(legend.position = "bottom", 
          panel.grid.minor.x = element_blank(),
          text = element_text(face = "plain", family = regular),
          legend.title = element_text(face = "bold", family = regular, 
                                      size = 10),
          legend.text = element_text( size = 10, family = regular))
  
  fig_right <- 
    monthly_reservation_trajectories %>% 
    mutate(date = as.Date(yearmon)) %>%
    ggplot(aes(date, n, colour = FREH_feb)) +
    geom_line(lwd = 1) +
    scale_x_date(name = NULL) +
    scale_y_continuous(name = "Average monthly reservations", limits = c(5, NA), 
                       label = scales::label_number(accuracy = 1)) +
    scale_color_manual(name = "FREH status in January-February 2020", 
                       values = col_palette[c(5, 1)]) +
    theme_minimal() +
    theme(legend.position = "bottom", 
          panel.grid.minor.x = element_blank(),
          text = element_text(face = "plain", family = regular),
          legend.title = element_text(face = "bold", family = regular,
                                      size = 10),
          legend.text = element_text(size = 10, family = regular))
  
  fig_left + fig_right + plot_layout(guides = 'collect') & 
    theme(legend.position = "bottom")

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_5.pdf"), 
         plot = figure_2_5_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_2_5.pdf"))
}

```

Figure \@ref(fig:fig-2-5) compares the activity of the FREH and non-FREH listings which have remained active during the pandemic. The left panel shows the total reserved nights which occurred in each of these two groups. Unsurprisingly, it demonstrates that the large majority of reservations in the months prior to the pandemic occurred in these FREH properties. For example, in the month of February 2020, `r feb_2020_FREH_pct` of all reserved nights were booked in these FREH properties. In March 2020, reservations declined in both the FREH and non-FREH properties, but the decline is far larger in both relative and absolute terms among the FREH properties. The right panel aggregates the same data in a different fashion, showing the average number of booked nights per listing per month across the FREH and non-FREH listings. The same general pattern is observable: FREH listings receive substantially more bookings per month than non-FREH properties until March 2020, at which point both groups see their reservations decline, but the FREH listings decline much more sharply.

``` {r fig-2-5, include = TRUE, fig.cap = '(ref:fig-2-5)', fig.align = "center"}

figure_2_5_fun()

```

(ref:fig-2-5) _The total number of reservations per day (L) and the average reservations per listing per month (R), for listings which had FREH status in January or February 2020 and listings which did not (14-day average)_

The conclusion is that, while the entire STR market in Toronto has suffered an unprecedented collapse during the Covid-19 pandemic, this collapse has been disproportionately concentrated among dedicated STRs which have been responsible for thousands of units of rental housing lost in the city over the past several years. This raises the possibility that some of these units many have returned to the long-term rental market—a possibility that has been noted anecdotally in cities across Canada (McSheffrey 2020). We explore this possibility systematically in the next chapter.

\newpage
