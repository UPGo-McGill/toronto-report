# Short-term rentals in Vancouver: Regulatory compliance

<style type="text/css">
  body{
  font-family: Futura, Helvetica, Arial;
}
</style>

<br>

```{r setup, include = FALSE, echo = FALSE}

library(here)
source(here("R", "01_startup.R"))

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

# Function for checking file modifications
mtime <- function(files) lapply(Sys.glob(files), function(x) file.info(x)$mtime)

# Set this to TRUE to output PDF figures
build_figures <- TRUE

```

**Since the beginning of 2021, the percentage of STR listings operating with valid STR licenses increased consistently, from XX% on January 7th to 77.0% on January 28th. Among active active listings at the end of January 2021, 9.9% were operating with a valid license, 7.3% used a valid license for multiple listings, 79.2% displayed no licenses and listings that were either exempt or using a fake license amountd to less than 2% respectively. FREH listings have the highest rate of valid licenses (27.9%) among listing categories. Multilistings have the highest rate of duplicate licenses (17.7%). In total, 10.6% of active entire-home listings displayed a license number used by at least one other active entire-home listing, suggesting that license numbers are being shared in violation of the regulations. Non-conforming listings are concentrated in and around the Spadina Fort-York ward; however, Willowdale is the ward with the highest percentage of non-conforming listings (94.0%). Listings that categorized themselves as exempt from the new short-term rental by-law are the ones that earned the most on average during both Covid and since the start of 2019.**

## How many listings have licenses?

```{r listings_licenses, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())
qload(here("output", "geometry.qsm"), nthreads = availableCores())
qload(here("output", "regulation.qsm"), nthreads = availableCores())

january_listings <- 
  reg_4 %>% 
  select(property_ID, registration, registration_analyzed, postal_code) %>% 
  left_join(., property, by = "property_ID") %>% 
  st_as_sf()

# Count of registration compliance for displayed listings
table_1 <- 
  reg_1 %>% 
  group_by(registration_analyzed) %>% 
  summarize(n=n(), percentage = n()/nrow(reg_2)) %>% 
  mutate(date = as.Date("2021-01-07"))

table_2 <- 
  reg_2 %>% 
  group_by(registration_analyzed) %>% 
  summarize(n=n(), percentage = n()/nrow(reg_2)) %>% 
  mutate(date = as.Date("2021-01-10"))

table_3 <- 
  reg_3 %>% 
  group_by(registration_analyzed) %>% 
  summarize(n=n(), percentage = n()/nrow(reg_3)) %>% 
  mutate(date = as.Date("2020-01-15"))

table_4 <- 
  reg_4 %>% 
  group_by(registration_analyzed) %>% 
  summarize(n=n(), percentage = n()/nrow(reg_4)) %>% 
  mutate(date = as.Date("2020-01-26"))

table <- rbind(table_1, table_2, table_3, table_4)

# listings removed between scrape 2 and 3
listings_removed_jan_15 <- 
  (table_2 %>% filter(registration_analyzed == "No license") %>% pull(n)-
  table_3 %>% filter(registration_analyzed == "No license") %>% pull(n)) %>% 
  round(digit = -1) %>% 
  prettyNum(",")

# total number of active listings per scrape date in jan 2021
table_total <- 
  table %>%
  group_by(date) %>% 
  summarize(n=sum(n))

# active listings on January 7th
active_listings_jan_07 <- 
  table_total %>%
  group_by(date) %>% 
  summarize(n=sum(n)) %>% 
  filter(date == "2021-01-07") %>% 
  pull(n) %>% 
  round(digit = -1) %>% 
  prettyNum(",")

# active listings on January 26th
active_listings_jan_26 <- 
  table_total %>%
  group_by(date) %>% 
  summarize(n=sum(n)) %>% 
  filter(date == "2021-01-26") %>% 
  pull(n) %>% 
  round(digit = -1) %>% 
  prettyNum(",")

# total number of active listings per scrape date in jan 2021
active_listings_jan_07 <- 
  table_total %>%
  group_by(date) %>% 
  summarize(n=sum(n)) %>% 
  filter(date == "2021-01-07")

# Percentage listings with valid licenses
conform_listings_jan_7 <- 
  table %>% 
  filter(date == "2021-01-07", registration_analyzed == "Conform") %>% 
  pull(n) %>%
  round(digit = -1) %>% 
  prettyNum(",")

conform_listings_jan_7_perc <- 
  table %>% 
  filter(date == "2021-01-07", registration_analyzed == "Conform") %>% 
  pull(percentage) %>%
  round(3) %>% 
  scales::percent(0.1)

conform_listings_jan_26 <- 
  table %>% 
  filter(date == "2021-01-26", registration_analyzed == "Conform") %>% 
  pull(n) %>%
  round(digit = -1) %>% 
  prettyNum(",")

conform_listings_jan_26_perc <- 
  table %>% 
  filter(date == "2021-01-26", registration_analyzed == "Conform") %>% 
  pull(percentage) %>%
  round(3) %>% 
  scales::percent(0.1)

increase_conform_listings <- 
  ((table %>% filter(date == "2021-01-26", registration_analyzed == "Conform") %>% pull(n))-
  (table %>% filter(date == "2021-01-07", registration_analyzed == "Conform") %>% pull(n))) %>% 
  round(digit = -1) %>% 
  prettyNum(",")

rm(property, daily, GH)

```

As of the first of January, all STR operators in Toronto are required to have a municipal license. This means that all listings displayed on Airbnb (with the exception of properties rented exclusively for 30 days at a time or longer, and hotels and other tourist accommodations which are regulated separately) must have a license. Following the announcement of the coming into effect of the by-law, Airbnb's biggest competitor - VRBO - pulled out of the Toronto market. For listings currently operating in Toronto, license numbers are publicly displayed, and below we compare listing activity with license status. Our team scraped the Airbnb website on five occassions during the month of January 2021 to assess the impact of the new STR by-law on active listing and by listing type (entire-home listings, private rooms, FREH and multilistings). We have connected those scrapes with the City's Short-Term License database (available on Open Data), as well as with AirDNA's dataset until the end of 2020. 

``` {r make_fig_3_1}

figure_3_1_fun <- function(regular = "", condensed = "") {
  
  fig_3_1 <- 
    ggplot(data=table_total)+
    geom_line(aes(x=date, y= n), color=col_palette[5]) + 
    scale_x_date(name=NULL)+
    scale_y_continuous(name=NULL, label = scales::comma)+
    theme_minimal()
  
  
}

if (build_figures) {
  ggsave(here("output", "figures", "figure_3_1.pdf"), 
         plot = figure_3_1_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_3_1.pdf"))
}

```

Figure \@ref(fig:fig-4-1) shows the total number of active listings that were displayed on the Airbnb platform during the month of January. Between January 10th and 15th, there were `r listings_removed_jan_15` listings displaying no license that were removed, being most likely a mass removal from Airbnb. Since the beginning of January 2021, the number of active listings have been declining, going from `r active_listings_jan_07` on January 7th to `r active_listings_jan_26` on January 26th. 

``` {r fig-4-1, include = TRUE, fig.cap = '(ref:fig-4-1)', fig.align = "center"}

figure_3_1_fun()

```

(ref:fig-4-1) _Active listings displayed on Airbnb during the month of January 2021_

``` {r make_fig_3_2}

figure_3_2_fun <- function(regular = "", condensed = "") {
  
fig_left <- 
  table %>% 
  ggplot()+ 
  geom_line(aes(x=date, y= percentage, color=registration_analyzed)) +
  scale_colour_manual(name = "Conformity Status", values = col_palette[c(1,2,4,5,6)])+
  scale_x_date(name=NULL)+
  scale_y_continuous(name=NULL, label = scales::percent)+
  theme_minimal()+
  theme(legend.position = "right",
        text = element_text(#family = regular, 
          face = "plain"),
        legend.title = element_text(#family = regular, 
          face = "bold",
                                    size = 7),
        legend.title.align = 0.9,
        legend.text = element_text(#family = regular, 
          size = 7),
        strip.text = element_text(#family = regular, 
          face = "bold", size = 12)
  )

fig_right <- 
  table %>% 
  filter(registration_analyzed != "No license") %>% 
  ggplot()+ 
  geom_line(aes(x=date, y= percentage, color=registration_analyzed)) +
  scale_colour_manual(name = "Conformity Status", values = col_palette[c(1,2,4,5,6)])+
  scale_x_date(name=NULL)+
  scale_y_continuous(name=NULL, label = scales::percent)+
  theme_minimal()+
  theme(legend.position = "right",
        text = element_text(family = regular, face = "plain"),
        legend.title = element_text(family = regular, face = "bold",
                                    size = 7),
        legend.title.align = 0.9,
        legend.text = element_text(family = regular, 
                                   size = 7),
        strip.text = element_text(family = regular, 
                                  face = "bold", size = 12)
  )

fig_left + fig_right +  plot_layout(guides = 'collect') & 
  theme(legend.position = "right")
  
}

if (build_figures) {
  ggsave(here("output", "figures", "figure_3_2.pdf"), 
         plot = figure_3_2_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_3_1.pdf"))
}

```

Figure \@ref(fig:fig-4-2) shows the repartition of active listings by conformity status (the left figure filters out the listings without license for increased visibility). Throughout the month of January, there has been a decline in the percentage of listings displaying no license information, accompanied by an increase of listings displaying license information. On January 7th, `r conform_listings_jan_7` listings were conform to the regulation (an increase of `r conform_listings_jan_7_perc` listings). As soon as January 26th, `r lconform_listings_jan_26_perc` of all active listings were conforming to the STR regulation (an increase of `r increase_conform_listings`). The number of active listings using conform licenses but for multiple listings increased by the same rate.

``` {r fig-4-2, include = TRUE, fig.cap = '(ref:fig-4-1)', fig.align = "center"}

figure_3_2_fun()

```

(ref:fig-4-2) _Total active listings in January by conformity status (left) and active listings displaying license information by conformity status (right) on Airbnb_

## Listing regulatory compliance

```{r listing_compliance, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())
qload(here("output", "geometry.qsm"), nthreads = availableCores())
qload(here("output", "regulation.qsm"), nthreads = availableCores())

january_listings <- 
  reg_4 %>% 
  select(property_ID, registration, registration_analyzed, postal_code) %>% 
  left_join(., property, by = "property_ID") %>% 
  st_as_sf()

FREH_10 <-
  daily %>% 
  filter(property_ID %in% january_listings$property_ID) %>% 
  filter(date >= "2020-10-01", FREH_3 >= 0.5) %>%
  distinct(property_ID, .keep_all = TRUE) %>% 
  mutate(FREH_10 = TRUE) %>% 
  select(property_ID, FREH_10)

FREH_01 <-
  daily %>% 
  filter(property_ID %in% january_listings$property_ID) %>% 
  filter(date >= "2020-01-01", FREH_3 >= 0.5) %>%
  distinct(property_ID, .keep_all = TRUE) %>% 
  mutate(FREH_01 = TRUE) %>% 
  select(property_ID, FREH_01)

multi_10 <- 
  daily %>% 
  filter(property_ID %in% january_listings$property_ID) %>% 
  filter(date >= "2020-10-01", multi) %>%
  distinct(property_ID, .keep_all = TRUE) %>% 
  mutate(multi_10 = TRUE) %>% 
  select(property_ID, multi_10)

multi_01 <- 
  daily %>% 
  filter(property_ID %in% january_listings$property_ID) %>% 
  filter(date >= "2020-01-01", multi) %>%
  distinct(property_ID, .keep_all = TRUE) %>% 
  mutate(multi_01 = TRUE) %>% 
  select(property_ID, multi_01)

license_scrape <- 
  january_listings %>% 
  left_join(FREH_10) %>% 
  left_join(FREH_01) %>% 
  left_join(multi_10) %>% 
  left_join(multi_01) %>% 
  mutate(
    status_10 = case_when(
      active < "2020-10-01" ~ "Inactive",
      FREH_10 ~ "FREH",
      multi_10 ~ "Multilisting",
      TRUE ~ "Non-commercial"),
    status_01 = case_when(
      active < "2020-01-01" ~ "Inactive",
      FREH_01 ~ "FREH",
      multi_01 ~ "Multilisting",
      TRUE ~ "Non-commercial")) %>% 
  select(-c(FREH_10:multi_01)) %>% 
  mutate(status_10 = factor(status_10, levels = c("Inactive", "Non-commercial",
                                                  "Multilisting", "FREH")),
         status_01 = factor(status_01, levels = c("Inactive", "Non-commercial",
                                                  "Multilisting", "FREH")),
         license_status = factor(registration_analyzed, 
                                 levels = c("No license", "Fake License", "Invalid", 
                                            "Duplicates", "Exempt", "Conform")))

scraped_number <- 
  nrow(license_scrape) %>% 
  prettyNum(",")

valid_pct <- 
  license_scrape %>% 
  st_drop_geometry() %>% 
  summarize(pct = mean(license_status == "Conform")) %>% 
  pull(pct) %>% 
  scales::percent(0.1)

exempt_pct <- 
  license_scrape %>% 
  st_drop_geometry() %>% 
  summarize(pct = mean(license_status == "Exempt")) %>% 
  pull(pct) %>% 
  scales::percent(0.1)

duplicates_pct <- 
  license_scrape %>% 
  st_drop_geometry() %>% 
  summarize(pct = mean(license_status == "Duplicates")) %>% 
  pull(pct) %>% 
  scales::percent(0.1)

problem_pct <- 
  license_scrape %>% 
  st_drop_geometry() %>% 
  summarize(pct = mean(license_status %in% c("Fake", "Invalid", 
                                             "No license"))) %>% 
  pull(pct) %>% 
  scales::percent(0.1)

freh_valid_pct <- 
  license_scrape %>% 
  st_drop_geometry() %>% 
  filter(status_10 == "FREH") %>% 
  summarize(pct = mean(license_status == "Conform")) %>% 
  pull(pct) %>% 
  scales::percent(0.1)

freh_no_license_pct <- 
  license_scrape %>% 
  st_drop_geometry() %>% 
  filter(status_10 == "FREH") %>% 
  summarize(pct = mean(license_status == "No license")) %>% 
  pull(pct) %>% 
  scales::percent(0.1)

ml_duplicate_pct <- 
  license_scrape %>% 
  st_drop_geometry() %>% 
  filter(status_10 == "Multilisting") %>% 
  summarize(pct = mean(license_status == "Duplicates")) %>% 
  pull(pct) %>% 
  scales::percent(0.1)

min_no_license_pct <- 
  license_scrape %>% 
  st_drop_geometry() %>% 
  filter(status_10 != "FREH") %>% 
  summarize(pct = mean(license_status == "No license")) %>% 
  pull(pct) %>% 
  scales::percent(0.1)

eh_multiple_license <- 
  license_scrape %>% 
  st_drop_geometry() %>% 
  filter(license_status == "Duplicates", active >= "2020-10-01") %>% 
  filter(listing_type == "Entire home/apt") %>% 
  count(registration, sort = TRUE) %>% 
  filter(n > 1) %>%
  pull(n) %>% 
  sum()

pr_multiple_license <- 
  license_scrape %>% 
  st_drop_geometry() %>% 
  filter(license_status == "Duplicates", active >= "2020-10-01") %>% 
  filter(listing_type == "Private room") %>% 
  count(registration, sort = TRUE) %>% 
  filter(n > 1) %>%
  pull(n) %>% 
  sum()

eh_multiple_license_pct <- 
  license_scrape %>% 
  st_drop_geometry() %>% 
  filter(license_status == "Duplicates", active >= "2020-10-01") %>% 
  filter(listing_type == "Entire home/apt") %>% 
  nrow() %>% 
  {eh_multiple_license / .} %>% 
  scales::percent(0.1)

pr_multiple_license_pct <- 
  license_scrape %>% 
  st_drop_geometry() %>% 
  filter(license_status == "Duplicates", active >= "2020-10-01") %>% 
  filter(listing_type == "Private room") %>% 
  nrow() %>% 
  {eh_multiple_license / .} %>% 
  scales::percent(0.1)
  
rm(property, daily, GH)

```


In order to analyze the evolution of regulatory compliance among currently active listings, we scraped all Toronto listings that were active on the Airbnb website at the beginning of January 2021 and recorded the license number displayed on each listing. We scraped on multiple occasions throughout the month to look at the evolution of registration compliance among active listings.

``` {r make_fig_3_3}

figure_3_3_fun <- function(regular = "", condensed = "") {
  
    fig_left_1 <- 
    license_scrape %>%
    ggplot() +
    geom_histogram(aes(reorder(license_status, desc(license_status)), 
                       fill = status_10), stat = "count") + 
    xlab(NULL) +
    scale_fill_manual(name = "Listing status", 
                      values = col_palette[c(6, 2, 1, 4)]) +
    scale_y_continuous(name = NULL, labels = scales::comma) +
    theme_minimal() +    
    theme(legend.position = "bottom", 
          panel.grid.minor.x = element_blank(),
          text = element_text(face = "plain", family = regular),
          legend.title = element_text(face = "bold", family = regular, 
                                      size = 10),
          legend.text = element_text(size = 10, family = regular))
  
  fig_right_1 <- 
    license_scrape %>% 
    ggplot() +
    geom_bar(aes(reorder(license_status, desc(license_status)), 
                 fill = status_10), position = "fill", stat = "count") +
    xlab(NULL) +
    scale_fill_manual(name = "Listing status", 
                      values = col_palette[c(6, 2, 1, 4)]) +
    scale_y_continuous(name = NULL, labels = scales::percent) +
    theme_minimal() +
    theme(legend.position = "bottom", 
          panel.grid.minor.x = element_blank(),
          text = element_text(face = "plain", family = regular),
          legend.title = element_text(face = "bold", family = regular, 
                                      size = 10),
          legend.text = element_text(size = 10, family = regular))
  
  fig_left_2 <- 
    license_scrape %>% 
    ggplot() +
    geom_histogram(aes(reorder(status_10, desc(status_10)), 
                       fill = license_status), stat = "count") + 
    xlab(NULL) +
    scale_fill_manual(name = "License status", 
                      values = col_palette[c(6, 3, 2, 1, 4, 5, 7)]) +
    scale_y_continuous(name = NULL, labels = scales::comma) +
    theme_minimal() +
    theme(legend.position = "bottom", 
          panel.grid.minor.x = element_blank(),
          text = element_text(face = "plain", family = regular),
          legend.title = element_text(face = "bold", family = regular, 
                                      size = 10),
          legend.text = element_text(size = 10, family = regular))
  
  fig_right_2 <- 
    license_scrape %>% 
    ggplot() +
    geom_bar(aes(reorder(status_10, desc(status_10)), fill = license_status), 
             position = "fill", stat = "count") +
    xlab(NULL) +
    scale_fill_manual(name = "License status", 
                      values = col_palette[c(6, 3, 2, 1, 4, 5, 7)]) +
    scale_y_continuous(name = NULL, labels = scales::percent) +
    theme_minimal() +
    theme(legend.position = "bottom", 
          panel.grid.minor.x = element_blank(),
          text = element_text(face = "plain", family = regular),
          legend.title = element_text(face = "bold", family = regular, 
                                      size = 10),
          legend.text = element_text(size = 10, family = regular))
  
  p1 <- 
    fig_left_1 + fig_right_1 + plot_layout(guides = 'collect', ncol = 2,
                                           tag_level = 'new') & 
    theme(legend.position = "bottom", text = element_text(family = regular))
  
  p2 <- 
    fig_left_2 + fig_right_2 + plot_layout(guides = 'collect', ncol = 2,
                                           tag_level = 'new') & 
    theme(legend.position = "bottom", text = element_text(family = regular))
  
  (p1 / p2) + plot_layout(ncol = 1) + 
    plot_annotation(tag_levels = c("A", "1"),
                    theme = theme(text = element_text(family = regular)))
  
}

if (build_figures) {
  ggsave(here("output", "figures", "figure_3_3.pdf"), 
         plot = figure_3_3_fun("Futura", "Futura Condensed"), 
         width = 8, height = 7, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_3_3.pdf"))
}

```

Figure \@ref(fig:fig-4-3) shows the `r scraped_number` active listings that displayed on January 26th when we performed our fourth scrape of license numbers. The top row (A) organizes listings by their license status. Out of the total `r scraped_number` listings, `r valid_pct` had a valid license, which is a 3-point percentage increase since our first scrape on January 7th. A further `r exempt_pct` claimed to be exempt, and `r duplicates_pct` had a city-issued license, but used this license for multiple listings at the same time. This leaves `r problem_pct` of listings which either had a fake license number (an entry which was in the proper format but which did not correspond to an actual license number issued by the City) or no license number at all. FREH listings (either FREH listings or multilistings) are over-represented among listings which have valid licenses and listings using a fake license; multilistings were the ones where there were the most duplicates licenses used; while listings that are neither FREH or multilistings and listings that were displayed on Airbnb but did not receive any activity since October were disproportionately likely to be listings without any license information.

``` {r fig-4-3, include = TRUE, fig.cap = '(ref:fig-4-3)', fig.align = "center"}

figure_3_3_fun()

```

(ref:fig-4-3) _License status and listing status (in October 2020) for listings displayed on Airbnb in end of January 2021_

The bottom row (B) of Figure \@ref(fig:fig-4-3) organizes listings by their activity status on Airbnb in the month of October 2020. It demonstrates that FREH listings are the only category of listing where a significant proportion (`r freh_valid_pct`) had valid licenses. To be clear, all commercial operations are per se non-compliant with the City's licensing rules, since a host cannot operate a frequently rented entire-home listing or multiple entire-home listings in their principal residence. But these listings were disproportionately likely to have a license. Only `r freh_no_license_pct` of FREH listings were missing a license, compared to the `r min_no_license_pct` of other listings which were missing a license. It is not a safe assumption that listings displaying a valid number are in fact operating in conformity with the City's regulation, however. `r eh_multiple_license` (`r eh_multiple_license_pct`) of active entire-home listings and `r pr_multiple_license` (`r pr_multiple_license_pct`) of active private room listings displayed a license number which was being used by at least one other active listing. Unless these listings are duplicates of the same property, most of them must be operating in violation of the City's regulations. 

## Geographic distribution of non-conforming listings

```{r geography, cache = TRUE, cache.lazy = FALSE}

map_table <- 
  WD %>% 
  st_join(january_listings %>% select(-ward)) %>% 
  filter(active >= max(active, na.rm = T) - days(30), 
         registration_analyzed != "Exempt") %>% 
  count(ward, valid = registration_analyzed == "Conform") %>% 
  group_by(ward) %>% 
  summarize(invalid = n[!valid], invalid_pct = n[!valid] / sum(n))

spadina_illegal_num <- 
  map_table %>% 
  filter(ward == "Spadina-Fort York") %>% 
  pull(invalid) %>%  
  prettyNum(",")

university_illegal_num <- 
  map_table %>% 
  filter(ward == "University-Rosedale") %>% 
  pull(invalid) %>%  
  prettyNum(",")

spadina_illegal_pct <- 
  map_table %>% 
  filter(ward == "Spadina-Fort York") %>% 
  pull(invalid_pct) %>% 
  scales::percent(0.1)

willowdale_illegal_pct <- 
  map_table %>% 
  filter(ward == "Willowdale") %>% 
  pull(invalid_pct) %>% 
  scales::percent(0.1)

scar_n_illegal_pct <- 
  map_table %>% 
  filter(ward == "Scarborough North") %>% 
  pull(invalid_pct) %>% 
  scales::percent(0.1)

```


``` {r make_fig_3_4}

figure_3_4_fun <- function(regular = "", condensed = "") {

map_table %>% 
  ggplot() +
  geom_sf(aes(fill = invalid_pct), colour = "white") +
  scale_fill_gradientn(colors = col_palette[c(3, 4, 5)], na.value = "grey80",
                       oob = scales::squish, 
                       labels = scales::percent_format(accuracy = 1))  +
  geom_sf_text(aes(label = invalid), colour = "black") +
  guides(fill = guide_colourbar(title = "Non-conforming listings")) + 
  theme_void() +
    theme(legend.position = "bottom", 
          panel.grid.minor.x = element_blank(),
          text = element_text(face = "plain", family = regular),
          legend.title = element_text(face = "bold", family = regular, 
                                      size = 10),
          legend.text = element_text(size = 8, family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_3_4.pdf"), 
         plot = figure_3_4_fun("Futura", "Futura Condensed"), 
         width = 4, height = 4.4, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_3_4.pdf"))
}

```

Listing validity throughout Toronto is overall still low, which is understandable since the new registration has come into effect less than a month ago. Additionally, business uncertainty among STR operators is still extremely high amidst the Covid-19 pandemic and its effects on the STR markets. Still, it is interesting to observe the concentration of non-conforming listings, both in number and percentage, in all of Toronto's wards. The wards with the most non-conforming listings (i.e. listings with fake, invalid, duplicates, or missing license numbers) in absolute terms are Spadina-Fort York with `r spadina_illegal_num` listings (`r spadina_illegal_pct`) and University-Rosedale with `r university_illegal_pct` listings (`r university_illegal_num`). In relative numbers, the wards with highest percentage of non-conforming listings are Willowdale (`r willowdale_illegal_pct`) and Scarborough North (`r scar_n_illegal_pct`) (Figure \@ref(fig:fig-4-4)).

``` {r fig-4-4, include = TRUE, fig.cap = '(ref:fig-4-4)', fig.align = "center"}

figure_3_4_fun()

```

(ref:fig-4-4) _Geographical distribution of non-conforming listings._

## Daily activity of entire-home listings by regulatory compliance

```{r license_activity, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

qload(here("output", "str_processed.qsm"), nthreads = availableCores())

eh_license <-
  january_listings %>% 
  st_drop_geometry() %>% 
  filter(active >= max(active, na.rm = T) - days(30)) %>% 
  filter(listing_type == "Entire home/apt") %>%
  select(property_ID, registration_analyzed)

pr_license <-
  january_listings %>% 
  st_drop_geometry() %>% 
  filter(active >= max(active, na.rm = T) - days(30)) %>% 
  filter(listing_type == "Private room") %>%
  select(property_ID, registration_analyzed)

daily_status <-
  daily %>% 
  filter(date >= key_date_covid, property_ID %in% eh_license$property_ID) %>%
  group_by(property_ID) %>% 
  count(status) %>% 
  mutate(sum_status = sum(n)) %>% 
  ungroup() %>% 
  pivot_wider(id_cols = c("property_ID", "sum_status"), names_from = "status", 
              values_from = "n") %>% 
  mutate(A = ifelse(is.na(A), 0, A),
         R = ifelse(is.na(R), 0, R),
         B = ifelse(is.na(B), 0, B),
         per_A = A / sum_status,
         per_R = R / sum_status,
         per_B = B / sum_status) %>% 
  select(-sum_status, -A, -R, -B)

license_activity <- inner_join(eh_license, daily_status, by = "property_ID")

revenue_covid <-
  daily %>% 
  filter(status == "R", date >= key_date_covid,
         property_ID %in% eh_license$property_ID) %>%
  group_by(property_ID) %>% 
  summarize(revenue = sum(price)) %>% 
  left_join(st_drop_geometry(select(january_listings, property_ID, created)), 
            by = "property_ID") %>% 
  mutate(created_or_covid = 
           as.Date(if_else(created <= key_date_covid, key_date_covid, created), 
                   origin = "1970-01-01")) %>% 
  mutate(revenue = revenue / as.numeric(max(daily$date) - created_or_covid)) %>% 
  filter(revenue != Inf) %>% 
  select(property_ID, revenue)

license_activity <- 
  inner_join(license_activity, revenue_covid, by = "property_ID") %>% 
  mutate(revenue = if_else(is.na(revenue), 0, revenue))

revenue_start_2019 <-
  daily %>% 
  filter(status == "R", date >= start_2019,
         property_ID %in% eh_license$property_ID) %>%
  group_by(property_ID) %>% 
  summarize(revenue = sum(price)) %>% 
  left_join(st_drop_geometry(select(january_listings, property_ID, created)), 
            by = "property_ID") %>% 
  mutate(created_or_regulations = 
           as.Date(if_else(created <= start_2019, 
                           start_2019, created), 
                   origin = "1970-01-01")) %>% 
  mutate(revenue = revenue / as.numeric(max(daily$date) - 
                                          created_or_regulations)) %>% 
  filter(revenue != Inf) %>% 
  select(property_ID, revenue_reg = revenue)

license_activity <- 
  inner_join(license_activity, revenue_start_2019, by = "property_ID") %>% 
  mutate(revenue_reg = if_else(is.na(revenue_reg), 0, revenue_reg))

all_listings <- 
  license_activity %>% 
  summarize(n = n(), across(per_A:revenue_reg, mean)) %>% 
  mutate(registration_analyzed = "All listings")

license_activity <-
  all_listings %>% 
  bind_rows(license_activity %>% 
              group_by(registration_analyzed) %>%
              summarize(n = n(), across(per_A:revenue_reg, mean))) %>% 
  select(registration_analyzed, everything())

valid_r_pct <- 
  license_activity %>% 
  filter(registration_analyzed == "Conform") %>% 
  pull(per_R) %>% 
  scales::percent(0.1)

no_license_r_pct <- 
  license_activity %>% 
  filter(registration_analyzed == "No license") %>% 
  pull(per_R) %>% 
  scales::percent(0.1)

exempt_r_pct <- 
  license_activity %>% 
  filter(registration_analyzed == "Exempt") %>% 
  pull(per_R) %>% 
  scales::percent(0.1)

exempt_rev <- 
  license_activity %>% 
  filter(registration_analyzed == "Exempt") %>% 
  pull(revenue) %>% 
  scales::dollar(1)

fake_r_pct <- 
  license_activity %>% 
  filter(registration_analyzed == "Fake License") %>% 
  pull(per_R) %>% 
  scales::percent(0.1)

fake_rev <- 
  license_activity %>% 
  filter(registration_analyzed == "Fake License") %>% 
  pull(revenue) %>% 
  scales::dollar(1)

valid_rev <- 
  license_activity %>% 
  filter(registration_analyzed == "Conform") %>% 
  pull(revenue) %>% 
  scales::dollar(1)

rm(property, daily, GH)

```

How does registration conformity impact business in the short-term rental market? We analyzed reservation, availability and revenue patterns of all active entire-home listings to understand the relationship between displaying a valid license number and STR activity. Table \@ref(tab:tab-license) summarizes this information. Entire-home listings with valid licenses have significantly higher reservation rates (`r valid_r_pct`) than listings with no displayed licenses (`r no_license_r_pct`). Listings that acquired licenses also earned more revenue per night since the start of 2019 and since the onset of the Covid-19 pandemic. Nevertheless, it is the listings that proclaim that they are exempt from the regulation that have earned more during both time periods (with a nightly average revenue of `r exempt_rev` during the pandemic). Among listings which are not conform, it is listings with fake license numbers (i.e. numbers which follow the correct YY-#### format but do not correspond to a number actually issued by the City) which have been reserved the most on average (`r fake_r_pct`), and the second highest earner among all groups (with a nightly revenue of `r fake_rev` during the pandemic). We can thus say that listings that have been more successful - both in terms of revenue and availability - in the past year are the ones most likely to obtain a business license, or to at least display some form of registration information on their listing.

``` {r tab-license, include = TRUE}

library(kableExtra)

license_activity[c(1, 2, 4, 3, 5, 6),] %>% 
  mutate(n = prettyNum(n, ",")) %>% 
  mutate(across(per_A:per_B, scales::percent, 0.1)) %>% 
  mutate(across(revenue:revenue_reg, scales::dollar, 1)) %>% 
  set_names(c("License status","Number of entire-home listings", "Nights available", 
              "Nights reserved", "Nights blocked", 
              "Revenue per night since Covid-19", 
              "Revenue per night since the start of 2019")) %>% 
  kbl(caption = "STR activity by license status", align = "lrrrrrr") %>%
  kable_styling(latex_options = "scale_down")

```

The implications of this analysis are: 1) displaying a license number is associated with greater previous success in the STR market in Toronto, and 2) it is not important whether the license number is valid. STR operators which took the initiative to either get a license number, use a valid license number for more than one listing or enter a fake license number are the ones that have had more activity on Airbnb and most likely intend to continue operating on short-term rental platforms.

\newpage
